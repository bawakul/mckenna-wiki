---
phase: 06-export
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/app/analysis/modules/[id]/page.tsx
  - src/components/export/ExportButtons.tsx
  - src/components/export/BulkExportButton.tsx
  - src/app/modules/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can export single module as markdown from trace page"
    - "User can export single module as CSV from trace page"
    - "User can bulk export all modules as markdown ZIP from modules page"
    - "User can bulk export all modules as single CSV from modules page"
    - "Export buttons show loading state during download"
  artifacts:
    - path: "src/components/export/ExportButtons.tsx"
      provides: "Single module export buttons component"
      exports: ["ExportButtons"]
    - path: "src/components/export/BulkExportButton.tsx"
      provides: "Bulk export button with ZIP/CSV support"
      exports: ["BulkExportButton"]
    - path: "src/app/analysis/modules/[id]/page.tsx"
      provides: "Trace page with export buttons"
      contains: "<ExportButtons"
    - path: "src/app/modules/page.tsx"
      provides: "Modules page with bulk export"
      contains: "<BulkExportButton"
  key_links:
    - from: "src/components/export/ExportButtons.tsx"
      to: "/api/export/markdown/[moduleId]"
      via: "fetch call on button click"
      pattern: "fetch.*api/export/markdown"
    - from: "src/components/export/BulkExportButton.tsx"
      to: "client-zip"
      via: "downloadZip import"
      pattern: "import.*downloadZip.*from.*client-zip"
---

<objective>
Add export UI to trace page and modules page

Purpose: Connect the export infrastructure from Plan 01 to user-facing buttons. Users can export single modules from the trace page or bulk export all modules from the modules list.

Output: Export buttons on /analysis/modules/[id] and "Export All" buttons on /modules page, both with loading states.
</objective>

<execution_context>
@/Users/bharadwajkulkarni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bharadwajkulkarni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-export/06-CONTEXT.md
@.planning/phases/06-export/06-RESEARCH.md

# Need to see existing page structure
@src/app/analysis/modules/[id]/page.tsx
@src/app/modules/page.tsx
@src/lib/types/module.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export button components</name>
  <files>
    src/components/export/ExportButtons.tsx
    src/components/export/BulkExportButton.tsx
  </files>
  <action>
Create export button components in `src/components/export/`:

**src/components/export/ExportButtons.tsx:**
```typescript
'use client'

import { useState } from 'react'

interface ExportButtonsProps {
  moduleId: string
  moduleName: string
}

export function ExportButtons({ moduleId, moduleName }: ExportButtonsProps) {
  const [loadingMd, setLoadingMd] = useState(false)
  const [loadingCsv, setLoadingCsv] = useState(false)

  async function handleExport(format: 'markdown' | 'csv') {
    const setLoading = format === 'markdown' ? setLoadingMd : setLoadingCsv
    setLoading(true)

    try {
      const response = await fetch(`/api/export/${format}/${moduleId}`)
      if (!response.ok) throw new Error('Export failed')

      // Get filename from Content-Disposition or generate one
      const contentDisposition = response.headers.get('Content-Disposition')
      let filename = `${moduleName}.${format === 'markdown' ? 'md' : 'csv'}`
      if (contentDisposition) {
        const match = contentDisposition.match(/filename="(.+?)"/)
        if (match) filename = match[1]
      }

      // Download file
      const blob = await response.blob()
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      link.download = filename
      link.click()
      link.remove()
      URL.revokeObjectURL(url)
    } catch (error) {
      console.error('Export failed:', error)
      alert('Export failed. Please try again.')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="flex items-center gap-2">
      <button
        onClick={() => handleExport('markdown')}
        disabled={loadingMd}
        className="rounded-lg border border-zinc-300 px-3 py-1.5 text-sm font-medium text-zinc-700 hover:bg-zinc-100 disabled:opacity-50 dark:border-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-800"
      >
        {loadingMd ? 'Exporting...' : 'Export MD'}
      </button>
      <button
        onClick={() => handleExport('csv')}
        disabled={loadingCsv}
        className="rounded-lg border border-zinc-300 px-3 py-1.5 text-sm font-medium text-zinc-700 hover:bg-zinc-100 disabled:opacity-50 dark:border-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-800"
      >
        {loadingCsv ? 'Exporting...' : 'Export CSV'}
      </button>
    </div>
  )
}
```

**src/components/export/BulkExportButton.tsx:**
```typescript
'use client'

import { downloadZip } from 'client-zip'
import sanitize from 'sanitize-filename'
import { useState } from 'react'

interface Module {
  id: string
  name: string
}

interface BulkExportButtonProps {
  modules: Module[]
  format: 'markdown' | 'csv'
}

export function BulkExportButton({ modules, format }: BulkExportButtonProps) {
  const [loading, setLoading] = useState(false)

  async function handleExport() {
    if (modules.length === 0) {
      alert('No modules to export')
      return
    }

    setLoading(true)

    try {
      // Fetch all module exports in parallel
      const results = await Promise.all(
        modules.map(async (module) => {
          const response = await fetch(`/api/export/${format}/${module.id}`)
          if (!response.ok) throw new Error(`Failed to export ${module.name}`)
          const content = await response.text()
          return { module, content }
        })
      )

      const timestamp = new Date().toISOString().split('T')[0]

      if (format === 'csv') {
        // CSV: combine into single file with all modules
        // Skip header for subsequent files, add module column
        const combined = results.map(r => r.content).join('\n')
        const blob = new Blob([combined], { type: 'text/csv' })
        const link = document.createElement('a')
        link.href = URL.createObjectURL(blob)
        link.download = `mckenna-all-modules-${timestamp}.csv`
        link.click()
        link.remove()
        URL.revokeObjectURL(link.href)
      } else {
        // Markdown: ZIP with separate files per module
        const files = results.map(r => ({
          name: sanitize(`${r.module.name}.md`, { replacement: '-' }) || 'module.md',
          lastModified: new Date(),
          input: r.content
        }))

        const blob = await downloadZip(files).blob()
        const link = document.createElement('a')
        link.href = URL.createObjectURL(blob)
        link.download = `mckenna-all-modules-${timestamp}.zip`
        link.click()
        link.remove()
        URL.revokeObjectURL(link.href)
      }
    } catch (error) {
      console.error('Bulk export failed:', error)
      alert('Export failed. Please try again.')
    } finally {
      setLoading(false)
    }
  }

  const label = format === 'markdown' ? 'Export All (ZIP)' : 'Export All (CSV)'
  const loadingLabel = 'Exporting...'

  return (
    <button
      onClick={handleExport}
      disabled={loading || modules.length === 0}
      className="rounded-lg border border-zinc-300 px-3 py-1.5 text-sm font-medium text-zinc-700 hover:bg-zinc-100 disabled:opacity-50 dark:border-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-800"
    >
      {loading ? loadingLabel : label}
    </button>
  )
}
```

**Key patterns:**
- 'use client' directive for browser-side interactivity
- Loading state during async operations
- URL.createObjectURL + link.click pattern for downloads
- Proper cleanup with URL.revokeObjectURL
- Error handling with user-facing alert
- client-zip for browser-side ZIP generation
- sanitize-filename for safe filenames in ZIP
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles without errors</verify>
  <done>ExportButtons.tsx and BulkExportButton.tsx exist and compile</done>
</task>

<task type="auto">
  <name>Task 2: Add export buttons to trace page and modules page</name>
  <files>
    src/app/analysis/modules/[id]/page.tsx
    src/app/modules/page.tsx
  </files>
  <action>
Update existing pages to include export buttons:

**src/app/analysis/modules/[id]/page.tsx:**

Add import at top:
```typescript
import { ExportButtons } from '@/components/export/ExportButtons'
```

Add ExportButtons below the module title/description, inside the header section. Find the closing div after moduleWithCount.notes and add the ExportButtons there. Insert after line ~52 (after the notes paragraph, before the closing div):

```typescript
<ExportButtons moduleId={id} moduleName={moduleWithCount.name} />
```

The updated header section should look like:
```typescript
<div className="flex-1">
  <Link ...>‚Üê Back to modules</Link>
  <h1 ...>{moduleWithCount.name}...</h1>
  {moduleWithCount.notes && (
    <p ...>{moduleWithCount.notes}</p>
  )}
  <div className="mt-4">
    <ExportButtons moduleId={id} moduleName={moduleWithCount.name} />
  </div>
</div>
```

**src/app/modules/page.tsx:**

Add imports at top:
```typescript
import { BulkExportButton } from '@/components/export/BulkExportButton'
```

Add BulkExportButton after the "New Module" link button in the header. The header section should have bulk export buttons next to the New Module button:

```typescript
<div className="flex items-center gap-2">
  <BulkExportButton modules={modules} format="markdown" />
  <BulkExportButton modules={modules} format="csv" />
  <Link
    href="/modules/new"
    className="rounded-lg bg-zinc-900 px-4 py-2 text-sm font-medium text-white hover:bg-zinc-800 dark:bg-zinc-100 dark:text-zinc-900 dark:hover:bg-zinc-200"
  >
    New Module
  </Link>
</div>
```

Note: BulkExportButton only needs `{id, name}` from modules, which the page already fetches.
  </action>
  <verify>
1. Run `npx tsc --noEmit` to verify TypeScript compiles
2. Start dev server and verify:
   - /analysis/modules/[id] shows "Export MD" and "Export CSV" buttons
   - /modules shows "Export All (ZIP)" and "Export All (CSV)" buttons
3. Test export functionality:
   - Click "Export MD" on trace page - should download .md file
   - Click "Export CSV" on trace page - should download .csv file
   - Click "Export All (ZIP)" on modules page - should download .zip
   - Click "Export All (CSV)" on modules page - should download .csv
  </verify>
  <done>Export buttons visible and functional on both pages</done>
</task>

</tasks>

<verification>
1. **Components exist:** src/components/export/ExportButtons.tsx and BulkExportButton.tsx
2. **TypeScript compiles:** `npx tsc --noEmit` passes
3. **Trace page exports:**
   - Visit /analysis/modules/[valid-id]
   - "Export MD" and "Export CSV" buttons visible
   - Clicking buttons downloads files with correct content
4. **Modules page bulk export:**
   - Visit /modules
   - "Export All (ZIP)" and "Export All (CSV)" buttons visible
   - ZIP contains one .md file per module
   - CSV contains all modules in one file
5. **Loading states:** Buttons show "Exporting..." during download
6. **Error handling:** Failed exports show alert
</verification>

<success_criteria>
- ExportButtons component on module trace page
- BulkExportButton components on modules page
- Single module markdown export works (downloads .md file)
- Single module CSV export works (downloads .csv file)
- Bulk markdown export downloads ZIP with all modules
- Bulk CSV export downloads single CSV with all modules
- Loading states and error handling functional
</success_criteria>

<output>
After completion, create `.planning/phases/06-export/06-02-SUMMARY.md`
</output>
