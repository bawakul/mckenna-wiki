---
phase: 01.1-corpus-data-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/scrape/parser.ts
  - mckenna-corpus/transcripts/*.json (re-scraped)
autonomous: true

must_haves:
  truths:
    - "parser.ts extracts date from <h3> tag when present"
    - "parser.ts extracts topic tags from section#topics a.metadata-label-link elements"
    - "Date extraction handles missing h3 gracefully (returns null)"
    - "Topic tag extraction handles missing section#topics gracefully (returns empty array)"
    - "All 92 transcripts re-scraped with new extraction logic"
    - "JSON files contain date and topicTags fields populated from source"
  artifacts:
    - path: "scripts/scrape/parser.ts"
      provides: "Updated extraction logic for date and topic tags"
      contains: "section#topics"
    - path: "mckenna-corpus/transcripts/eros-and-the-eschaton.json"
      provides: "Sample transcript with extracted date and tags"
      contains: "topicTags"
  key_links:
    - from: "scripts/scrape/parser.ts"
      to: "mckenna-corpus/transcripts/*.json"
      via: "cheerio extraction"
      pattern: "\\$\\('h3'\\)|section#topics"
---

<objective>
Update the scraper parser to extract dates and topic tags from organism.earth HTML, then re-scrape all transcripts to populate these fields.

Purpose: Fix missing metadata discovered during Phase 3 UAT. The scraper had placeholder code setting `date: null` and `topicTags: []` instead of actually extracting these values.

Output: Updated parser.ts and re-scraped corpus with dates and topic tags populated from source.
</objective>

<execution_context>
@/Users/bharadwajkulkarni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bharadwajkulkarni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-corpus-data-fixes/01.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update parser.ts with date and topic tag extraction</name>
  <files>scripts/scrape/parser.ts</files>
  <action>
    1. Open `scripts/scrape/parser.ts` and locate lines 106-112 where date and topicTags are set.

    2. Replace the placeholder date extraction (lines 106-108):

       **Current code:**
       ```typescript
       // Date: NOT in structured metadata, set to null
       // (This could be extracted from title or URL in future enhancement)
       const date: string | null = null;
       ```

       **New code:**
       ```typescript
       // Extract date from <h3> tag (appears after h1 title and h2 subtitle)
       // Format varies: "March 25, 1994", "June 1989", etc.
       // Store as-is per Phase 1 decision (no normalization)
       const dateElement = $('h3').first();
       const date: string | null = dateElement.length > 0
         ? dateElement.text().trim()
         : null;
       ```

    3. Replace the placeholder topic tag extraction (lines 110-111):

       **Current code:**
       ```typescript
       // Topic tags and referenced authors: NOT reliably available, initialize empty
       const topicTags: string[] = [];
       ```

       **New code:**
       ```typescript
       // Extract topic tags from topics section
       // Structure: <section id="topics"><a class="metadata-label metadata-label-link">Tag Name</a></section>
       const topicTags: string[] = [];
       $('section#topics a.metadata-label-link').each((_, el) => {
         const tag = $(el).text().trim();
         if (tag) {
           topicTags.push(tag);
         }
       });
       ```

    4. The `referencedAuthors` line can remain as empty array (out of scope for Phase 1.1):
       ```typescript
       const referencedAuthors: string[] = [];
       ```

    IMPORTANT: Keep the comment about `referencedAuthors` brief - it's not part of this fix.
  </action>
  <verify>
    - `grep -n "section#topics" scripts/scrape/parser.ts` shows the new selector
    - `grep -n "\\$('h3')" scripts/scrape/parser.ts` shows date extraction
    - `npm run build` passes (TypeScript compiles without errors)
  </verify>
  <done>parser.ts updated with date and topic tag extraction using Cheerio selectors</done>
</task>

<task type="auto">
  <name>Task 2: Test extraction on sample transcripts</name>
  <files>mckenna-corpus/transcripts/*.json</files>
  <action>
    1. Run scraper on a limited set to verify extraction works:
       ```bash
       npm run scrape:test
       ```
       (This runs with --limit 10)

    2. Inspect a known transcript to verify date and tags are extracted:
       ```bash
       cat mckenna-corpus/transcripts/eros-and-the-eschaton.json | npx jq '{date, topicTags}'
       ```

       **Expected output (approximately):**
       ```json
       {
         "date": "March 25, 1994",
         "topicTags": [
           "Accelerating Change",
           "Cosmology",
           "Entropy and Syntropy",
           "Evolution",
           "Omega Point",
           "Psychedelics",
           "Technology"
         ]
       }
       ```

    3. Check another transcript to verify consistency:
       ```bash
       cat mckenna-corpus/transcripts/[another-transcript-id].json | npx jq '{date, topicTags}'
       ```

    4. If extraction is failing:
       - Check if date appears in different HTML structure for that transcript
       - Verify selector matches the actual HTML (compare to saved samples)
       - Log the raw HTML for debugging if needed

    5. Note any edge cases for verification step (transcripts without dates, without tags).
  </action>
  <verify>
    - At least 3 test transcripts have non-null dates
    - At least 3 test transcripts have non-empty topicTags arrays
    - No extraction errors in scraper output
  </verify>
  <done>Extraction tested and verified on sample transcripts before full re-scrape</done>
</task>

<task type="auto">
  <name>Task 3: Re-scrape full corpus</name>
  <files>mckenna-corpus/transcripts/*.json</files>
  <action>
    1. Run full scrape to update all 92 transcripts:
       ```bash
       npm run scrape
       ```

    2. Monitor output for any errors or warnings.

    3. After completion, verify corpus integrity:
       ```bash
       npm run verify:corpus
       ```
       (If this script exists, run it; otherwise, do manual checks below)

    4. Generate a quick coverage report to see how many transcripts have dates vs tags:
       ```bash
       # Count transcripts with dates
       grep -l '"date":' mckenna-corpus/transcripts/*.json | wc -l

       # Count transcripts with topic tags (non-empty)
       grep -l '"topicTags":\[".* mckenna-corpus/transcripts/*.json | wc -l
       ```

    5. Log the results for the summary:
       - Total transcripts scraped
       - Transcripts with dates (expected: high percentage, >90%)
       - Transcripts with topic tags (expected: high percentage, >90%)
       - Any transcripts with null dates or empty tags (document if any)
  </action>
  <verify>
    - All 92 transcripts have updated JSON files with scrapedAt timestamp updated
    - No scrape errors in output
    - Coverage report shows expected high percentages for date and tag extraction
  </verify>
  <done>Full corpus re-scraped with date and topic tag extraction</done>
</task>

</tasks>

<verification>
- `grep "section#topics" scripts/scrape/parser.ts` returns match (selector is present)
- `grep "\\$('h3')" scripts/scrape/parser.ts` returns match (date extraction is present)
- Sample JSON file contains non-null date: `cat mckenna-corpus/transcripts/eros-and-the-eschaton.json | grep '"date":'`
- Sample JSON file contains non-empty topicTags: `cat mckenna-corpus/transcripts/eros-and-the-eschaton.json | grep -A 10 '"topicTags":'`
- All 92 transcripts present in corpus directory: `ls mckenna-corpus/transcripts/*.json | wc -l` returns 92
</verification>

<success_criteria>
1. parser.ts contains updated extraction logic for date and topic tags
2. At least 90% of transcripts have non-null dates after re-scrape
3. At least 90% of transcripts have non-empty topicTags arrays after re-scrape
4. Full corpus (92 transcripts) successfully re-scraped without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-corpus-data-fixes/01.1-01-SUMMARY.md`
</output>
