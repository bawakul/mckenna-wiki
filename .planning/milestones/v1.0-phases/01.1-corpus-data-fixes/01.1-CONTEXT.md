# Phase 1.1: Corpus Data Fixes - Context

**Phase:** 01.1-corpus-data-fixes
**Status:** Planning Complete
**Inserted After:** Phase 1 (Corpus Foundation)
**Reason:** Dates and topic tags not extracted during Phase 1 scraping; discovered during Phase 3 UAT

## Problem Statement

During Phase 3 UAT testing, it was discovered that:
1. **Dates are missing** - All transcripts have `date: null` in database
2. **Topic tags are missing** - All transcripts have empty `topic_tags: []` arrays

Root cause: The Phase 1 scraper (`parser.ts`) had placeholder code that explicitly set these fields to null/empty instead of extracting them from the HTML.

## Scope

**In Scope:**
- Update parser.ts to extract date from `<h3>` tag
- Update parser.ts to extract topic tags from `section#topics a.metadata-label-link` elements
- Re-scrape all 92 transcripts with updated extraction logic
- Re-seed database with updated corpus data
- Verify data integrity and coverage

**Out of Scope:**
- Date normalization (store as-is per Phase 1 decision: "March 25, 1994", "June 1989", etc.)
- Referenced authors extraction (separate section exists but not required for current features)
- UI updates for date display or topic filtering (Phase 3 may already have this; document state)

## Technical Approach

### HTML Structure (from organism.earth samples)

**Date location:**
```html
<h1>Eros and the Eschaton</h1>
<h2>What Science Forgot: The Importance of Human Beings</h2>
<h3>March 25, 1994</h3>  <!-- Date is here -->
```

**Topic tags location:**
```html
<section id="topics">
  <a class="metadata-label metadata-label-link" href="...">
    Accelerating Change
  </a>
  <a class="metadata-label metadata-label-link" href="...">
    Cosmology
  </a>
  <!-- More tags -->
</section>
```

### Extraction Code

```typescript
// Date extraction
const dateElement = $('h3').first();
const date: string | null = dateElement.length > 0
  ? dateElement.text().trim()
  : null;

// Topic tags extraction
const topicTags: string[] = [];
$('section#topics a.metadata-label-link').each((_, el) => {
  const tag = $(el).text().trim();
  if (tag) {
    topicTags.push(tag);
  }
});
```

### Workflow

1. **Update parser.ts** - Replace placeholder code with extraction logic
2. **Test on samples** - Run scrape:test (--limit 10) to verify extraction
3. **Re-scrape full corpus** - Run scrape to update all 92 transcripts
4. **Re-seed database** - Run seed to upsert updated data
5. **Verify data** - Run SQL queries to check coverage and integrity

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Store dates as-is | Phase 1 established "no normalization" principle; varying granularity is valid data |
| Use Cheerio selectors | Consistent with Phase 1 scraper pattern; reliable for static HTML |
| Re-scrape + re-seed | Maintains data integrity; upsert handles updates cleanly |
| Skip referenced authors | Not required for Phase 1.1 success criteria; can add later if needed |

## Success Criteria

From PROJECT.md Phase 1.1 requirements:
1. Dates are extracted from organism.earth pages and stored in database
2. Topic tags are extracted from organism.earth pages and stored in database
3. Transcript list sorts chronologically by actual dates
4. Topic tag filters appear on transcript list page

## Plans

- **01.1-01-PLAN.md** (Wave 1): Update parser, test extraction, re-scrape corpus
- **01.1-02-PLAN.md** (Wave 2): Re-seed database, verify data, generate tag catalog

## Dependencies

- **Upstream:** Phase 1 (Corpus Foundation) - scraper infrastructure exists
- **Downstream:** Phase 3 UI may need updates to display dates/filter by tags

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Some transcripts lack dates in source | Medium | Low | Accept null dates; document coverage |
| Some transcripts lack tags in source | Medium | Low | Accept empty arrays; document coverage |
| HTML structure varies across pages | Low | Medium | Test on multiple samples before full scrape |
| Upsert creates duplicates | Very Low | Medium | Use existing seed script with conflict resolution |

## References

- Research: `.planning/phases/01.1-corpus-data-fixes/01.1-RESEARCH.md`
- Phase 3 UAT: `.planning/phases/03-reading-interface/03-UAT.md`
- Parser code: `scripts/scrape/parser.ts`
- Seed script: `scripts/seed/import-corpus.ts`
- HTML samples: `scripts/scrape/samples/mckenna-doc-*.html`
