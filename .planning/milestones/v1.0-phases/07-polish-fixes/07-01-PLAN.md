---
phase: 07-polish-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/007_enable_rls.sql
  - src/lib/annotations/selectors.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "RLS is enabled on all four tables (transcripts, transcript_paragraphs, modules, annotations)"
    - "Permissive policies allow all operations for anon role"
    - "App continues to function identically after RLS is enabled"
    - "Highlight offset bug is fixed — selected text matches stored highlight position"
    - "getOffsetInParagraph scopes offset calculation to the <p> element, not the wrapper div"
  artifacts:
    - path: "supabase/migrations/007_enable_rls.sql"
      provides: "RLS enable statements and permissive policies for all tables"
      contains: "enable row level security"
    - path: "src/lib/annotations/selectors.ts"
      provides: "Fixed getOffsetInParagraph scoped to <p> text element"
      contains: "querySelector('p')"
  key_links:
    - from: "supabase/migrations/007_enable_rls.sql"
      to: "Supabase database"
      via: "Applied via Supabase dashboard SQL editor"
      pattern: "alter table.*enable row level security"
    - from: "src/lib/annotations/selectors.ts"
      to: "src/components/transcripts/ParagraphView.tsx"
      via: "getOffsetInParagraph scoped to <p> inside data-paragraph-id div"
      pattern: "querySelector\\('p'\\)"
---

<objective>
Fix two surgical issues: enable Row Level Security with permissive policies on all database tables, and fix the highlight offset bug where selected text renders shifted forward due to timestamp/speaker label text being included in offset calculation.

Purpose: Security hardening (RLS) and fixing the most user-visible annotation bug (offset shift)
Output: RLS migration SQL file, fixed selectors.ts
</objective>

<execution_context>
@/Users/bharadwajkulkarni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bharadwajkulkarni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-fixes/07-RESEARCH.md
@src/lib/annotations/selectors.ts
@src/components/transcripts/ParagraphView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RLS migration with permissive policies</name>
  <files>supabase/migrations/007_enable_rls.sql</files>
  <action>
Create migration file `supabase/migrations/007_enable_rls.sql` with:

1. Enable RLS on all four tables:
   - `ALTER TABLE transcripts ENABLE ROW LEVEL SECURITY;`
   - `ALTER TABLE transcript_paragraphs ENABLE ROW LEVEL SECURITY;`
   - `ALTER TABLE modules ENABLE ROW LEVEL SECURITY;`
   - `ALTER TABLE annotations ENABLE ROW LEVEL SECURITY;`

2. Create permissive "allow all" policies for `anon` role on each table:
   ```sql
   CREATE POLICY "Allow all access" ON transcripts FOR ALL TO anon USING (true) WITH CHECK (true);
   CREATE POLICY "Allow all access" ON transcript_paragraphs FOR ALL TO anon USING (true) WITH CHECK (true);
   CREATE POLICY "Allow all access" ON modules FOR ALL TO anon USING (true) WITH CHECK (true);
   CREATE POLICY "Allow all access" ON annotations FOR ALL TO anon USING (true) WITH CHECK (true);
   ```

This is a personal tool — simple permissive policies are sufficient. The `anon` role covers unauthenticated Supabase client access. The `module_traces` view inherits RLS from underlying tables automatically.

Note: This SQL should be applied via the Supabase dashboard SQL editor (consistent with how migrations 001–006 have been applied). The file is created for documentation and version control.
  </action>
  <verify>
    <automated>cat supabase/migrations/007_enable_rls.sql | grep -c "enable row level security"</automated>
    <manual>Verify output is 4 (one per table). After applying via Supabase dashboard, verify app still works.</manual>
  </verify>
  <done>Migration file exists with RLS enabled on all 4 tables and permissive policies for anon role</done>
</task>

<task type="auto">
  <name>Task 2: Fix highlight offset bug in getOffsetInParagraph</name>
  <files>src/lib/annotations/selectors.ts</files>
  <action>
Fix the `getOffsetInParagraph` function in `src/lib/annotations/selectors.ts`.

**Root cause:** The function receives the wrapper `div[data-paragraph-id]` element but calls `.textContent` on it, which concatenates timestamp text + speaker label text + paragraph text. This shifts the calculated offset forward by the length of the timestamp and speaker label strings.

**Fix:** Scope the offset calculation to the `<p>` element inside the wrapper div (which contains only the actual paragraph text):

1. At the start of `getOffsetInParagraph`, find the `<p>` element:
   ```typescript
   const textElement = paragraph.querySelector('p') ?? paragraph
   ```

2. Replace `paragraph.textContent` with `textElement.textContent` for the `paragraphText` variable

3. In the TreeWalker fallback, create the TreeWalker rooted at `textElement` instead of `paragraph`:
   ```typescript
   const treeWalker = document.createTreeWalker(
     textElement,
     NodeFilter.SHOW_TEXT,
     null
   )
   ```

This ensures offsets are calculated relative to the `<p>` text content only, matching what the user selected. The `<p>` element in ParagraphView contains only `paragraph.text` — the timestamp `<span>` and speaker `<div>` are siblings, not children of `<p>`.

**Note:** Existing stored annotations with wrong offsets will remain wrong (they were saved with the shifted values). This is acceptable — only new annotations will be correctly anchored. The `TextQuoteSelector` in existing annotations still has the correct `exact` text, so re-anchoring via text search will still work.
  </action>
  <verify>
    <automated>cd "/Users/bharadwajkulkarni/Documents /Bawa's Lab/mckenna-wiki" && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Create a new highlight on a paragraph with a timestamp — verify the highlight renders exactly over the selected text, not shifted forward</manual>
  </verify>
  <done>getOffsetInParagraph scopes offset calculation to the `<p>` text element, excluding timestamp and speaker label text from offset computation</done>
</task>

</tasks>

<verification>
- [ ] `supabase/migrations/007_enable_rls.sql` exists with 4 ALTER TABLE statements and 4 CREATE POLICY statements
- [ ] `getOffsetInParagraph` in selectors.ts uses `paragraph.querySelector('p')` to scope to text element
- [ ] TreeWalker fallback in `getOffsetInParagraph` also scoped to the `<p>` element
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
- RLS migration SQL ready for application via Supabase dashboard
- Highlight offset bug fixed in code — new annotations will have correct offsets
- No TypeScript compilation errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-fixes/07-01-SUMMARY.md`
</output>
