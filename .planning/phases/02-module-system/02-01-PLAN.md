---
phase: 02-module-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/004_create_modules_table.sql
  - src/lib/supabase/server.ts
  - src/lib/supabase/client.ts
  - src/lib/types/module.ts
autonomous: true

must_haves:
  truths:
    - "modules table exists in Supabase with citext name column"
    - "Server-side Supabase client can be imported and used in Server Components"
    - "Module TypeScript types are defined and exported"
  artifacts:
    - path: "supabase/migrations/004_create_modules_table.sql"
      provides: "Database schema for modules"
      contains: "CREATE TABLE modules"
    - path: "src/lib/supabase/server.ts"
      provides: "Server-side Supabase client factory"
      exports: ["createClient"]
    - path: "src/lib/types/module.ts"
      provides: "Module types and Zod schemas"
      exports: ["Module", "ModuleSchema"]
  key_links:
    - from: "src/lib/supabase/server.ts"
      to: "@supabase/supabase-js"
      via: "createServerClient import"
      pattern: "createServerClient"
---

<objective>
Create the foundation for the module system: database table, Supabase server client, and TypeScript types.

Purpose: Establish the data layer and type safety for all subsequent module operations
Output: Database migration, server client utility, and module type definitions
</objective>

<execution_context>
@/Users/bharadwajkulkarni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bharadwajkulkarni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-module-system/02-CONTEXT.md
@.planning/phases/02-module-system/02-RESEARCH.md

# Existing schema for reference
@supabase/migrations/001_create_corpus_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create modules database migration</name>
  <files>supabase/migrations/004_create_modules_table.sql</files>
  <action>
Create SQL migration for the modules table with:

1. Enable citext extension (for case-insensitive unique names):
   ```sql
   CREATE EXTENSION IF NOT EXISTS citext;
   ```

2. Create modules table:
   - `id` UUID PRIMARY KEY with gen_random_uuid() default
   - `name` citext NOT NULL UNIQUE (case-insensitive uniqueness)
   - `notes` TEXT (nullable, for markdown content)
   - `color` TEXT NOT NULL (hex color like '#e9d5ff')
   - `last_used_at` TIMESTAMPTZ (nullable, for "recently used" sorting)
   - `created_at` TIMESTAMPTZ DEFAULT NOW()
   - `updated_at` TIMESTAMPTZ DEFAULT NOW()

3. Create updated_at trigger (reuse existing function if available, or create new):
   - Use `update_updated_at_column()` function from 001 migration

4. Create index on last_used_at for sorting performance:
   ```sql
   CREATE INDEX idx_modules_last_used_at ON modules(last_used_at DESC NULLS LAST);
   ```

5. Add comment explaining the table purpose

Note: Do NOT add foreign key to highlights table yet - that's Phase 4.
  </action>
  <verify>
Run migration via Supabase dashboard SQL editor or CLI:
- citext extension enabled
- modules table created with all columns
- unique constraint on name is case-insensitive
- updated_at trigger attached
  </verify>
  <done>modules table exists with citext name column, UUID id, color, notes, last_used_at fields</done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase server client utility</name>
  <files>src/lib/supabase/server.ts, src/lib/supabase/client.ts</files>
  <action>
Create server-side Supabase client following Next.js 16 + App Router patterns.

**src/lib/supabase/server.ts:**
```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing sessions.
          }
        },
      },
    }
  )
}
```

**src/lib/supabase/client.ts** (for client components if needed later):
```typescript
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

Install @supabase/ssr if not present:
```bash
npm install @supabase/ssr
```

Ensure .env.local has (example values, actual values should exist):
```
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
```
  </action>
  <verify>
- Files exist at specified paths
- @supabase/ssr is in package.json dependencies
- TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>Server and client Supabase utilities are importable from src/lib/supabase/</done>
</task>

<task type="auto">
  <name>Task 3: Create Module types and Zod schemas</name>
  <files>src/lib/types/module.ts</files>
  <action>
Create TypeScript types and Zod validation schemas for modules.

```typescript
import { z } from 'zod'

/**
 * Preset color palette for modules (muted/pastel colors)
 * These match Tailwind's color-100/200 shades
 */
export const PRESET_COLORS = [
  { name: 'Purple', value: '#e9d5ff' },
  { name: 'Pink', value: '#fae8ff' },
  { name: 'Yellow', value: '#fef3c7' },
  { name: 'Green', value: '#d1fae5' },
  { name: 'Blue', value: '#dbeafe' },
  { name: 'Indigo', value: '#e0e7ff' },
  { name: 'Rose', value: '#fce7f3' },
  { name: 'Orange', value: '#fed7aa' },
  { name: 'Gray', value: '#d4d4d8' },
  { name: 'Red', value: '#fca5a5' },
] as const

export type PresetColor = typeof PRESET_COLORS[number]['value']

/**
 * Zod schema for creating/updating a module
 * Validates input before database operations
 */
export const ModuleInputSchema = z.object({
  name: z
    .string()
    .min(1, 'Name is required')
    .max(100, 'Name must be under 100 characters'),
  notes: z.string().optional().default(''),
  color: z
    .string()
    .regex(/^#[0-9a-fA-F]{6}$/, 'Invalid color format')
    .default(PRESET_COLORS[0].value),
})

export type ModuleInput = z.infer<typeof ModuleInputSchema>

/**
 * Full module as stored in database
 */
export interface Module {
  id: string
  name: string
  notes: string | null
  color: string
  last_used_at: string | null
  created_at: string
  updated_at: string
}

/**
 * Module with usage count (for delete confirmation)
 */
export interface ModuleWithUsageCount extends Module {
  highlight_count: number
}

/**
 * Soft character limit for module names (UI warning threshold)
 */
export const MODULE_NAME_SOFT_LIMIT = 40

/**
 * Check if name exceeds soft limit (for UI warning, not hard block)
 */
export function isNameOverSoftLimit(name: string): boolean {
  return name.length > MODULE_NAME_SOFT_LIMIT
}
```
  </action>
  <verify>
- File exists at src/lib/types/module.ts
- TypeScript compiles: `npx tsc --noEmit`
- Types can be imported: add test import in a temp file
  </verify>
  <done>Module types, Zod schemas, and preset colors are defined and exported</done>
</task>

</tasks>

<verification>
1. Database: Run migration in Supabase, verify table structure in Table Editor
2. Server client: Create test Server Component that imports createClient
3. Types: Import Module and ModuleInputSchema in a test file, verify no TS errors
</verification>

<success_criteria>
- [ ] modules table exists in Supabase with citext extension enabled
- [ ] name column has case-insensitive unique constraint
- [ ] src/lib/supabase/server.ts exports createClient function
- [ ] src/lib/types/module.ts exports Module type and ModuleInputSchema
- [ ] npm run build succeeds without type errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-module-system/02-01-SUMMARY.md`
</output>
