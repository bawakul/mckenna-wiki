---
phase: 02-module-system
plan: 04
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/components/modules/ModuleSelector.tsx
  - src/components/modules/InlineModuleCreator.tsx
autonomous: true

must_haves:
  truths:
    - "Floating selector component can be positioned near any reference element"
    - "Selector shows modules sorted by recently used (most recent first)"
    - "Selector has 'Create new module' option for inline creation"
    - "Inline creator allows quick module creation without leaving context"
  artifacts:
    - path: "src/components/modules/ModuleSelector.tsx"
      provides: "Floating module selector for reading interface"
      min_lines: 80
    - path: "src/components/modules/InlineModuleCreator.tsx"
      provides: "Quick inline module creation form"
      min_lines: 40
  key_links:
    - from: "src/components/modules/ModuleSelector.tsx"
      to: "@floating-ui/react"
      via: "positioning hooks"
      pattern: "useFloating"
    - from: "src/components/modules/ModuleSelector.tsx"
      to: "src/app/modules/actions.ts"
      via: "Server Action call"
      pattern: "getModulesSortedByRecent"
---

<objective>
Create the floating module selector component for quick tagging during reading.

Purpose: Enable fast module selection near text selections (Phase 4 will wire to selection events)
Output: Floating UI-based selector with recently-used sorting and inline creation
</objective>

<execution_context>
@/Users/bharadwajkulkarni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bharadwajkulkarni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-module-system/02-CONTEXT.md
@.planning/phases/02-module-system/02-RESEARCH.md
@.planning/phases/02-module-system/02-01-SUMMARY.md
@.planning/phases/02-module-system/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Floating UI dependency</name>
  <files>package.json</files>
  <action>
Install @floating-ui/react for positioning the floating selector:

```bash
npm install @floating-ui/react
```

This provides:
- useFloating hook for positioning
- offset, flip, shift middleware for smart positioning
- useClick, useDismiss for interaction handling
- Automatic cleanup on unmount
  </action>
  <verify>
- @floating-ui/react in package.json dependencies
- `npm run build` still succeeds
  </verify>
  <done>@floating-ui/react installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create inline module creator component</name>
  <files>src/components/modules/InlineModuleCreator.tsx</files>
  <action>
Create a minimal form for quick module creation within the selector dropdown.

```typescript
'use client'

import { useState } from 'react'
import { createModule } from '@/app/modules/actions'
import { PRESET_COLORS } from '@/lib/types/module'

interface InlineModuleCreatorProps {
  onCreated: (moduleId: string) => void
  onCancel: () => void
}

export function InlineModuleCreator({ onCreated, onCancel }: InlineModuleCreatorProps) {
  const [name, setName] = useState('')
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    if (!name.trim()) return

    setIsSubmitting(true)
    setError(null)

    // Auto-assign first available color
    const formData = new FormData()
    formData.set('name', name.trim())
    formData.set('color', PRESET_COLORS[0].value)
    formData.set('notes', '')

    const result = await createModule(formData)

    if (!result.success) {
      setError(result.fieldErrors?.name?.[0] || result.error)
      setIsSubmitting(false)
      return
    }

    onCreated(result.data.id)
  }

  return (
    <form onSubmit={handleSubmit} className="p-2 border-t border-zinc-200 dark:border-zinc-700">
      <div className="flex gap-2">
        <input
          type="text"
          value={name}
          onChange={(e) => setName(e.target.value)}
          placeholder="New module name"
          className="
            flex-1 rounded-md border border-zinc-300 dark:border-zinc-600
            px-2 py-1.5 text-sm bg-white dark:bg-zinc-800
            text-zinc-900 dark:text-zinc-100
            placeholder:text-zinc-400
            focus:border-zinc-500 focus:outline-none focus:ring-1 focus:ring-zinc-500
          "
          autoFocus
          disabled={isSubmitting}
        />
        <button
          type="submit"
          disabled={!name.trim() || isSubmitting}
          className="
            rounded-md bg-zinc-900 px-3 py-1.5 text-sm font-medium text-white
            hover:bg-zinc-800 disabled:opacity-50 disabled:cursor-not-allowed
            dark:bg-zinc-100 dark:text-zinc-900 dark:hover:bg-zinc-200
          "
        >
          {isSubmitting ? '...' : 'Add'}
        </button>
        <button
          type="button"
          onClick={onCancel}
          className="
            rounded-md border border-zinc-300 dark:border-zinc-600
            px-2 py-1.5 text-sm text-zinc-600 dark:text-zinc-400
            hover:bg-zinc-50 dark:hover:bg-zinc-800
          "
        >
          Cancel
        </button>
      </div>
      {error && (
        <p className="mt-1 text-xs text-red-600 dark:text-red-400">{error}</p>
      )}
    </form>
  )
}
```
  </action>
  <verify>
- Component exists at path
- TypeScript compiles without errors
  </verify>
  <done>Inline creator allows quick name-only module creation with auto-assigned color</done>
</task>

<task type="auto">
  <name>Task 3: Create floating module selector component</name>
  <files>src/components/modules/ModuleSelector.tsx</files>
  <action>
Create the floating selector using Floating UI for positioning.

```typescript
'use client'

import { useState, useEffect } from 'react'
import {
  useFloating,
  useClick,
  useDismiss,
  useInteractions,
  offset,
  flip,
  shift,
  autoUpdate,
} from '@floating-ui/react'
import { getModulesSortedByRecent, touchModuleLastUsed } from '@/app/modules/actions'
import { InlineModuleCreator } from './InlineModuleCreator'
import type { Module } from '@/lib/types/module'

interface ModuleSelectorProps {
  /** Called when user selects a module */
  onSelect: (moduleId: string) => void
  /** Called when selector is dismissed without selection */
  onDismiss?: () => void
  /** Custom trigger element (optional - uses default button if not provided) */
  trigger?: React.ReactNode
  /** Control open state externally (for programmatic triggering) */
  open?: boolean
  /** Callback when open state changes */
  onOpenChange?: (open: boolean) => void
  /** Position relative to reference */
  placement?: 'top' | 'bottom' | 'left' | 'right' | 'top-start' | 'top-end' | 'bottom-start' | 'bottom-end'
}

export function ModuleSelector({
  onSelect,
  onDismiss,
  trigger,
  open: controlledOpen,
  onOpenChange,
  placement = 'bottom-start',
}: ModuleSelectorProps) {
  // Controlled vs uncontrolled open state
  const [uncontrolledOpen, setUncontrolledOpen] = useState(false)
  const isControlled = controlledOpen !== undefined
  const isOpen = isControlled ? controlledOpen : uncontrolledOpen

  const setIsOpen = (newOpen: boolean) => {
    if (isControlled) {
      onOpenChange?.(newOpen)
    } else {
      setUncontrolledOpen(newOpen)
    }
    if (!newOpen && onDismiss) {
      onDismiss()
    }
  }

  // Module data
  const [modules, setModules] = useState<Module[]>([])
  const [isLoading, setIsLoading] = useState(false)
  const [showInlineCreator, setShowInlineCreator] = useState(false)

  // Floating UI setup
  const { refs, floatingStyles, context } = useFloating({
    open: isOpen,
    onOpenChange: setIsOpen,
    placement,
    middleware: [
      offset(8),
      flip({ fallbackPlacements: ['top-start', 'bottom-end', 'top-end'] }),
      shift({ padding: 8 }),
    ],
    whileElementsMounted: autoUpdate,
  })

  const click = useClick(context)
  const dismiss = useDismiss(context, {
    outsidePressEvent: 'mousedown',
  })
  const { getReferenceProps, getFloatingProps } = useInteractions([click, dismiss])

  // Load modules when opening
  useEffect(() => {
    if (isOpen) {
      loadModules()
    }
  }, [isOpen])

  async function loadModules() {
    setIsLoading(true)
    const result = await getModulesSortedByRecent()
    if (result.success) {
      setModules(result.data)
    }
    setIsLoading(false)
  }

  async function handleSelect(moduleId: string) {
    // Update last_used_at for the selected module
    await touchModuleLastUsed(moduleId)
    onSelect(moduleId)
    setIsOpen(false)
    setShowInlineCreator(false)
  }

  function handleInlineCreated(moduleId: string) {
    // Immediately select the newly created module
    handleSelect(moduleId)
  }

  return (
    <>
      {/* Reference element (trigger) */}
      <div ref={refs.setReference} {...getReferenceProps()}>
        {trigger || (
          <button
            type="button"
            className="
              rounded-md bg-zinc-100 px-3 py-1.5 text-sm font-medium text-zinc-700
              hover:bg-zinc-200 dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700
            "
          >
            Tag with Module
          </button>
        )}
      </div>

      {/* Floating dropdown */}
      {isOpen && (
        <div
          ref={refs.setFloating}
          style={floatingStyles}
          {...getFloatingProps()}
          className="
            z-50 w-64 rounded-lg border border-zinc-200 bg-white shadow-lg
            dark:border-zinc-700 dark:bg-zinc-900
            max-h-80 overflow-hidden flex flex-col
          "
        >
          {/* Module list */}
          <div className="overflow-y-auto flex-1">
            {isLoading ? (
              <div className="p-4 text-center text-sm text-zinc-500">
                Loading modules...
              </div>
            ) : modules.length === 0 ? (
              <div className="p-4 text-center text-sm text-zinc-500">
                No modules yet
              </div>
            ) : (
              <ul className="py-1">
                {modules.map((module) => (
                  <li key={module.id}>
                    <button
                      type="button"
                      onClick={() => handleSelect(module.id)}
                      className="
                        w-full text-left px-3 py-2 flex items-center gap-2
                        hover:bg-zinc-100 dark:hover:bg-zinc-800
                        text-zinc-900 dark:text-zinc-100
                      "
                    >
                      <span
                        className="w-3 h-3 rounded-full flex-shrink-0"
                        style={{ backgroundColor: module.color }}
                      />
                      <span className="truncate text-sm">{module.name}</span>
                    </button>
                  </li>
                ))}
              </ul>
            )}
          </div>

          {/* Create new option */}
          {showInlineCreator ? (
            <InlineModuleCreator
              onCreated={handleInlineCreated}
              onCancel={() => setShowInlineCreator(false)}
            />
          ) : (
            <button
              type="button"
              onClick={() => setShowInlineCreator(true)}
              className="
                w-full text-left px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400
                hover:bg-zinc-50 dark:hover:bg-zinc-800
                border-t border-zinc-200 dark:border-zinc-700
                flex items-center gap-2
              "
            >
              <span className="w-3 h-3 flex items-center justify-center text-zinc-400">+</span>
              Create new module
            </button>
          )}
        </div>
      )}
    </>
  )
}
```

This component:
1. Uses Floating UI for smart positioning with flip/shift
2. Supports both controlled and uncontrolled open state
3. Loads modules sorted by recently used when opened
4. Updates last_used_at when a module is selected
5. Allows inline module creation without leaving the selector
6. Supports custom trigger elements for Phase 4 integration
  </action>
  <verify>
- File exists and TypeScript compiles
- Import from @floating-ui/react works
- Component exports are correct
  </verify>
  <done>Floating selector positions near trigger, shows recently-used modules, allows inline creation</done>
</task>

</tasks>

<verification>
1. @floating-ui/react installed in dependencies
2. TypeScript compiles: `npx tsc --noEmit`
3. Component can be imported and used in a test page
4. Floating positioning works with different placements
</verification>

<success_criteria>
- [ ] @floating-ui/react is installed
- [ ] ModuleSelector uses useFloating with offset/flip/shift middleware
- [ ] Modules load sorted by last_used_at (most recent first)
- [ ] Selecting a module updates last_used_at
- [ ] "Create new module" opens inline creator
- [ ] Inline creation auto-assigns color and creates module
- [ ] Selector dismisses on outside click
- [ ] Component supports both controlled and uncontrolled modes
</success_criteria>

<output>
After completion, create `.planning/phases/02-module-system/02-04-SUMMARY.md`
</output>
