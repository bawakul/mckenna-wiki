---
phase: 02-module-system
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/app/modules/page.tsx
  - src/app/modules/new/page.tsx
  - src/app/modules/[id]/edit/page.tsx
  - src/components/modules/ModuleForm.tsx
  - src/components/modules/ModuleColorPicker.tsx
  - src/components/modules/ModuleCard.tsx
  - src/components/modules/DeleteModuleDialog.tsx
autonomous: false

must_haves:
  truths:
    - "User can view all modules on /modules page"
    - "User can create a new module on /modules/new"
    - "User can edit a module on /modules/[id]/edit"
    - "User can delete a module with confirmation showing affected highlight count"
    - "Color picker shows preset palette (not full color wheel)"
    - "8 seed modules exist after checkpoint (MODL-02 requirement)"
  artifacts:
    - path: "src/app/modules/page.tsx"
      provides: "Module list page (Server Component)"
      min_lines: 30
    - path: "src/app/modules/new/page.tsx"
      provides: "Create module page"
      min_lines: 20
    - path: "src/components/modules/ModuleForm.tsx"
      provides: "Reusable module form component"
      min_lines: 50
    - path: "src/components/modules/ModuleColorPicker.tsx"
      provides: "Preset color palette picker"
      min_lines: 30
  key_links:
    - from: "src/app/modules/page.tsx"
      to: "src/lib/supabase/server.ts"
      via: "data fetching"
      pattern: "createClient"
    - from: "src/components/modules/ModuleForm.tsx"
      to: "src/app/modules/actions.ts"
      via: "form submission"
      pattern: "createModule|updateModule"
---

<objective>
Build the Modules management UI: list page, create/edit pages, and reusable form components.

Purpose: Provide full CRUD interface for managing thematic modules
Output: Complete module management pages with color picker and delete confirmation
</objective>

<execution_context>
@/Users/bharadwajkulkarni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bharadwajkulkarni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-module-system/02-CONTEXT.md
@.planning/phases/02-module-system/02-RESEARCH.md
@.planning/phases/02-module-system/02-01-SUMMARY.md
@.planning/phases/02-module-system/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create module list page and card component</name>
  <files>src/app/modules/page.tsx, src/components/modules/ModuleCard.tsx</files>
  <action>
Create the modules list page as a Server Component and a reusable card component.

**src/app/modules/page.tsx:**
```typescript
import { createClient } from '@/lib/supabase/server'
import { ModuleCard } from '@/components/modules/ModuleCard'
import Link from 'next/link'
import type { Module } from '@/lib/types/module'

export default async function ModulesPage() {
  const supabase = await createClient()
  const { data: modules } = await supabase
    .from('modules')
    .select('*')
    .order('created_at', { ascending: false })

  return (
    <div className="min-h-screen bg-zinc-50 dark:bg-zinc-900">
      <div className="mx-auto max-w-4xl px-4 py-12">
        <div className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-3xl font-bold text-zinc-900 dark:text-zinc-50">
              Modules
            </h1>
            <p className="mt-2 text-zinc-600 dark:text-zinc-400">
              Thematic categories for tagging passages in McKenna lectures
            </p>
          </div>
          <Link
            href="/modules/new"
            className="rounded-lg bg-zinc-900 px-4 py-2 text-sm font-medium text-white hover:bg-zinc-800 dark:bg-zinc-100 dark:text-zinc-900 dark:hover:bg-zinc-200"
          >
            New Module
          </Link>
        </div>

        {modules && modules.length > 0 ? (
          <div className="grid gap-4 sm:grid-cols-2">
            {modules.map((module: Module) => (
              <ModuleCard key={module.id} module={module} />
            ))}
          </div>
        ) : (
          <div className="rounded-lg border border-dashed border-zinc-300 p-12 text-center dark:border-zinc-700">
            <p className="text-zinc-600 dark:text-zinc-400">
              No modules yet. Create your first module to start tagging passages.
            </p>
            <Link
              href="/modules/new"
              className="mt-4 inline-block text-sm font-medium text-zinc-900 underline dark:text-zinc-100"
            >
              Create your first module
            </Link>
          </div>
        )}
      </div>
    </div>
  )
}
```

**src/components/modules/ModuleCard.tsx:**
```typescript
import Link from 'next/link'
import type { Module } from '@/lib/types/module'

interface ModuleCardProps {
  module: Module
}

export function ModuleCard({ module }: ModuleCardProps) {
  return (
    <Link
      href={`/modules/${module.id}/edit`}
      className="group block rounded-lg border border-zinc-200 bg-white p-4 transition-shadow hover:shadow-md dark:border-zinc-800 dark:bg-zinc-950"
    >
      <div className="flex items-start gap-3">
        <div
          className="mt-1 h-4 w-4 rounded-full flex-shrink-0"
          style={{ backgroundColor: module.color }}
        />
        <div className="flex-1 min-w-0">
          <h3 className="font-medium text-zinc-900 dark:text-zinc-100 truncate group-hover:text-zinc-700 dark:group-hover:text-zinc-300">
            {module.name}
          </h3>
          {module.notes && (
            <p className="mt-1 text-sm text-zinc-600 dark:text-zinc-400 line-clamp-2">
              {module.notes}
            </p>
          )}
        </div>
      </div>
    </Link>
  )
}
```
  </action>
  <verify>
- Visit /modules in browser (should show empty state or list)
- ModuleCard displays color indicator and truncates long names
- "New Module" button links to /modules/new
  </verify>
  <done>Modules list page shows all modules with cards linking to edit pages</done>
</task>

<task type="auto">
  <name>Task 2: Create color picker and form components</name>
  <files>src/components/modules/ModuleColorPicker.tsx, src/components/modules/ModuleForm.tsx</files>
  <action>
Create reusable form components for module creation and editing.

**src/components/modules/ModuleColorPicker.tsx:**
```typescript
'use client'

import { PRESET_COLORS } from '@/lib/types/module'

interface ModuleColorPickerProps {
  value: string
  onChange: (color: string) => void
  name?: string
}

export function ModuleColorPicker({
  value,
  onChange,
  name = 'color',
}: ModuleColorPickerProps) {
  return (
    <div>
      <label className="block text-sm font-medium text-zinc-900 dark:text-zinc-100 mb-2">
        Color
      </label>
      <div className="grid grid-cols-5 gap-2">
        {PRESET_COLORS.map(({ name: colorName, value: colorValue }) => (
          <button
            key={colorValue}
            type="button"
            onClick={() => onChange(colorValue)}
            className={`
              w-10 h-10 rounded-lg border-2 transition-all
              ${value === colorValue
                ? 'border-zinc-900 ring-2 ring-zinc-900 ring-offset-2 dark:border-zinc-100 dark:ring-zinc-100'
                : 'border-zinc-200 hover:border-zinc-400 dark:border-zinc-700 dark:hover:border-zinc-500'
              }
            `}
            style={{ backgroundColor: colorValue }}
            title={colorName}
            aria-label={`Select ${colorName}`}
          />
        ))}
      </div>
      <input type="hidden" name={name} value={value} />
    </div>
  )
}
```

**src/components/modules/ModuleForm.tsx:**
```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { ModuleColorPicker } from './ModuleColorPicker'
import { createModule, updateModule } from '@/app/modules/actions'
import { PRESET_COLORS, MODULE_NAME_SOFT_LIMIT, isNameOverSoftLimit } from '@/lib/types/module'
import type { Module } from '@/lib/types/module'

interface ModuleFormProps {
  module?: Module
  mode: 'create' | 'edit'
}

export function ModuleForm({ module, mode }: ModuleFormProps) {
  const router = useRouter()
  const [name, setName] = useState(module?.name ?? '')
  const [notes, setNotes] = useState(module?.notes ?? '')
  const [color, setColor] = useState(module?.color ?? PRESET_COLORS[0].value)
  const [error, setError] = useState<string | null>(null)
  const [fieldErrors, setFieldErrors] = useState<Record<string, string[]>>({})
  const [isSubmitting, setIsSubmitting] = useState(false)

  async function handleSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault()
    setError(null)
    setFieldErrors({})
    setIsSubmitting(true)

    const formData = new FormData(e.currentTarget)

    try {
      const result = mode === 'create'
        ? await createModule(formData)
        : await updateModule(module!.id, formData)

      if (!result.success) {
        setError(result.error)
        if (result.fieldErrors) {
          setFieldErrors(result.fieldErrors)
        }
        return
      }

      router.push('/modules')
      router.refresh()
    } finally {
      setIsSubmitting(false)
    }
  }

  const nameOverLimit = isNameOverSoftLimit(name)

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {error && !Object.keys(fieldErrors).length && (
        <div className="rounded-lg bg-red-50 p-4 text-sm text-red-700 dark:bg-red-900/30 dark:text-red-400">
          {error}
        </div>
      )}

      <div>
        <label htmlFor="name" className="block text-sm font-medium text-zinc-900 dark:text-zinc-100 mb-2">
          Name
        </label>
        <input
          type="text"
          id="name"
          name="name"
          value={name}
          onChange={(e) => setName(e.target.value)}
          className={`
            w-full rounded-lg border px-4 py-2 text-zinc-900 dark:text-zinc-100
            bg-white dark:bg-zinc-950
            ${fieldErrors.name
              ? 'border-red-500 focus:border-red-500 focus:ring-red-500'
              : 'border-zinc-300 dark:border-zinc-700 focus:border-zinc-500 focus:ring-zinc-500'
            }
            focus:outline-none focus:ring-2 focus:ring-offset-2
          `}
          placeholder="e.g., Novelty Theory"
          maxLength={100}
          required
        />
        <div className="mt-1 flex justify-between text-sm">
          {fieldErrors.name ? (
            <span className="text-red-600 dark:text-red-400">{fieldErrors.name[0]}</span>
          ) : nameOverLimit ? (
            <span className="text-amber-600 dark:text-amber-400">
              Consider a shorter name for better readability
            </span>
          ) : (
            <span />
          )}
          <span className={`${nameOverLimit ? 'text-amber-600 dark:text-amber-400' : 'text-zinc-500'}`}>
            {name.length}/{MODULE_NAME_SOFT_LIMIT}
          </span>
        </div>
      </div>

      <ModuleColorPicker value={color} onChange={setColor} />

      <div>
        <label htmlFor="notes" className="block text-sm font-medium text-zinc-900 dark:text-zinc-100 mb-2">
          Notes
          <span className="ml-2 text-zinc-500 font-normal">(optional)</span>
        </label>
        <textarea
          id="notes"
          name="notes"
          value={notes}
          onChange={(e) => setNotes(e.target.value)}
          rows={6}
          className="
            w-full rounded-lg border border-zinc-300 dark:border-zinc-700 px-4 py-2
            text-zinc-900 dark:text-zinc-100 bg-white dark:bg-zinc-950
            focus:border-zinc-500 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:ring-offset-2
          "
          placeholder="Capture your insights and understanding about this theme..."
        />
        <p className="mt-1 text-sm text-zinc-500">
          Use this space to write about the module's themes, patterns you've noticed, and evolving insights.
        </p>
      </div>

      <div className="flex gap-4">
        <button
          type="submit"
          disabled={isSubmitting}
          className="
            rounded-lg bg-zinc-900 px-6 py-2 text-sm font-medium text-white
            hover:bg-zinc-800 disabled:opacity-50 disabled:cursor-not-allowed
            dark:bg-zinc-100 dark:text-zinc-900 dark:hover:bg-zinc-200
          "
        >
          {isSubmitting ? 'Saving...' : mode === 'create' ? 'Create Module' : 'Save Changes'}
        </button>
        <button
          type="button"
          onClick={() => router.push('/modules')}
          className="
            rounded-lg border border-zinc-300 dark:border-zinc-700 px-6 py-2
            text-sm font-medium text-zinc-700 dark:text-zinc-300
            hover:bg-zinc-50 dark:hover:bg-zinc-800
          "
        >
          Cancel
        </button>
      </div>
    </form>
  )
}
```
  </action>
  <verify>
- Color picker renders 10 preset colors in a grid
- Form shows soft character limit warning when exceeded
- Submit button shows loading state
- Field errors display below inputs
  </verify>
  <done>Color picker and form components created with validation feedback</done>
</task>

<task type="auto">
  <name>Task 3: Create new/edit module pages with delete functionality</name>
  <files>src/app/modules/new/page.tsx, src/app/modules/[id]/edit/page.tsx, src/components/modules/DeleteModuleDialog.tsx</files>
  <action>
Create the create/edit pages and delete confirmation dialog.

**src/app/modules/new/page.tsx:**
```typescript
import { ModuleForm } from '@/components/modules/ModuleForm'
import Link from 'next/link'

export default function NewModulePage() {
  return (
    <div className="min-h-screen bg-zinc-50 dark:bg-zinc-900">
      <div className="mx-auto max-w-2xl px-4 py-12">
        <div className="mb-8">
          <Link
            href="/modules"
            className="text-sm text-zinc-600 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-zinc-100"
          >
            ← Back to Modules
          </Link>
          <h1 className="mt-4 text-3xl font-bold text-zinc-900 dark:text-zinc-50">
            New Module
          </h1>
          <p className="mt-2 text-zinc-600 dark:text-zinc-400">
            Create a thematic category for tagging passages
          </p>
        </div>

        <div className="rounded-lg border border-zinc-200 bg-white p-6 dark:border-zinc-800 dark:bg-zinc-950">
          <ModuleForm mode="create" />
        </div>
      </div>
    </div>
  )
}
```

**src/app/modules/[id]/edit/page.tsx:**
```typescript
import { createClient } from '@/lib/supabase/server'
import { ModuleForm } from '@/components/modules/ModuleForm'
import { DeleteModuleDialog } from '@/components/modules/DeleteModuleDialog'
import Link from 'next/link'
import { notFound } from 'next/navigation'

interface EditModulePageProps {
  params: Promise<{ id: string }>
}

export default async function EditModulePage({ params }: EditModulePageProps) {
  const { id } = await params
  const supabase = await createClient()

  const { data: module, error } = await supabase
    .from('modules')
    .select('*')
    .eq('id', id)
    .single()

  if (error || !module) {
    notFound()
  }

  return (
    <div className="min-h-screen bg-zinc-50 dark:bg-zinc-900">
      <div className="mx-auto max-w-2xl px-4 py-12">
        <div className="mb-8">
          <Link
            href="/modules"
            className="text-sm text-zinc-600 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-zinc-100"
          >
            ← Back to Modules
          </Link>
          <div className="mt-4 flex items-center gap-3">
            <div
              className="h-6 w-6 rounded-full"
              style={{ backgroundColor: module.color }}
            />
            <h1 className="text-3xl font-bold text-zinc-900 dark:text-zinc-50">
              Edit Module
            </h1>
          </div>
        </div>

        <div className="rounded-lg border border-zinc-200 bg-white p-6 dark:border-zinc-800 dark:bg-zinc-950">
          <ModuleForm module={module} mode="edit" />
        </div>

        <div className="mt-8 rounded-lg border border-red-200 bg-red-50 p-6 dark:border-red-900 dark:bg-red-950/30">
          <h2 className="text-lg font-medium text-red-900 dark:text-red-100">
            Danger Zone
          </h2>
          <p className="mt-1 text-sm text-red-700 dark:text-red-300">
            Deleting this module will remove it permanently. Highlights tagged with this module will become untagged.
          </p>
          <div className="mt-4">
            <DeleteModuleDialog moduleId={module.id} moduleName={module.name} />
          </div>
        </div>
      </div>
    </div>
  )
}
```

**src/components/modules/DeleteModuleDialog.tsx:**
```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { deleteModule, getModuleWithUsageCount } from '@/app/modules/actions'

interface DeleteModuleDialogProps {
  moduleId: string
  moduleName: string
}

export function DeleteModuleDialog({ moduleId, moduleName }: DeleteModuleDialogProps) {
  const router = useRouter()
  const [isOpen, setIsOpen] = useState(false)
  const [highlightCount, setHighlightCount] = useState<number | null>(null)
  const [isLoading, setIsLoading] = useState(false)
  const [isDeleting, setIsDeleting] = useState(false)
  const [error, setError] = useState<string | null>(null)

  async function handleOpenDialog() {
    setIsLoading(true)
    setError(null)

    const result = await getModuleWithUsageCount(moduleId)
    if (!result.success) {
      setError(result.error)
      setIsLoading(false)
      return
    }

    setHighlightCount(result.data.highlight_count)
    setIsOpen(true)
    setIsLoading(false)
  }

  async function handleDelete() {
    setIsDeleting(true)
    setError(null)

    const result = await deleteModule(moduleId)
    if (!result.success) {
      setError(result.error)
      setIsDeleting(false)
      return
    }

    router.push('/modules')
    router.refresh()
  }

  return (
    <>
      <button
        onClick={handleOpenDialog}
        disabled={isLoading}
        className="
          rounded-lg border border-red-300 px-4 py-2 text-sm font-medium text-red-700
          hover:bg-red-100 disabled:opacity-50 disabled:cursor-not-allowed
          dark:border-red-700 dark:text-red-300 dark:hover:bg-red-900/50
        "
      >
        {isLoading ? 'Loading...' : 'Delete Module'}
      </button>

      {isOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div className="mx-4 w-full max-w-md rounded-lg bg-white p-6 shadow-xl dark:bg-zinc-900">
            <h3 className="text-lg font-semibold text-zinc-900 dark:text-zinc-100">
              Delete "{moduleName}"?
            </h3>

            {error && (
              <div className="mt-4 rounded-lg bg-red-50 p-3 text-sm text-red-700 dark:bg-red-900/30 dark:text-red-400">
                {error}
              </div>
            )}

            <p className="mt-4 text-sm text-zinc-600 dark:text-zinc-400">
              {highlightCount === 0 ? (
                'This module has no tagged highlights and can be safely deleted.'
              ) : (
                <>
                  This will affect <strong className="text-zinc-900 dark:text-zinc-100">{highlightCount}</strong> highlight{highlightCount === 1 ? '' : 's'}.
                  {' '}Those highlights will become untagged but won't be deleted.
                </>
              )}
            </p>

            <div className="mt-6 flex justify-end gap-3">
              <button
                onClick={() => setIsOpen(false)}
                className="
                  rounded-lg border border-zinc-300 px-4 py-2 text-sm font-medium text-zinc-700
                  hover:bg-zinc-50 dark:border-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-800
                "
              >
                Cancel
              </button>
              <button
                onClick={handleDelete}
                disabled={isDeleting}
                className="
                  rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white
                  hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed
                "
              >
                {isDeleting ? 'Deleting...' : 'Delete Module'}
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  )
}
```
  </action>
  <verify>
- /modules/new displays create form
- /modules/[id]/edit displays edit form with existing data
- Delete dialog shows highlight count warning
- Cancel and confirm buttons work correctly
  </verify>
  <done>Create and edit pages working with delete confirmation dialog</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete module management UI with list, create, edit, and delete functionality</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Visit http://localhost:3000/modules
3. Verify empty state appears with "Create your first module" link
4. Click "New Module" and create a test module:
   - Enter name "Test Module"
   - Select a color
   - Add notes: "Test notes"
   - Click "Create Module"
5. Verify redirect to /modules and new module appears
6. Click module card to edit
7. Change color and save
8. Test delete:
   - Click "Delete Module" in Danger Zone
   - Verify dialog shows highlight count (0)
   - Cancel, then try again and confirm delete
9. Verify module is removed from list
10. Create the 8 seed modules (MODL-02 requirement):
    Create each module with a distinct color and optional notes.

    **Seed modules to create (user provides final names):**
    - Novelty Theory
    - Psychedelics & Consciousness
    - Time & Eschatology
    - Language & Meaning
    - Nature & Ecology
    - Technology & Culture
    - Shamanism & Archaic Revival
    - Imagination & Creativity

    (User may adjust these names during checkpoint - just confirm 8 modules exist)
11. Verify all 8 seed modules appear on /modules page with distinct colors
  </how-to-verify>
  <resume-signal>Type "approved" and confirm all 8 seed modules are created, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Create module flow: name validation, color picker, save works
2. Edit module flow: existing data loads, changes save
3. Delete flow: confirmation dialog shows count, deletion works
4. Empty state displays when no modules exist
5. UI matches design (color indicators, cards, forms)
</verification>

<success_criteria>
- [ ] /modules shows list of modules with color indicators
- [ ] /modules/new creates new module with form validation
- [ ] /modules/[id]/edit loads existing module and saves changes
- [ ] Delete confirmation shows affected highlight count
- [ ] Color picker displays 10 preset colors
- [ ] Name field shows soft character limit warning
- [ ] All pages have consistent dark mode support
- [ ] 8 seed modules created during checkpoint (MODL-02)
</success_criteria>

<output>
After completion, create `.planning/phases/02-module-system/02-03-SUMMARY.md`
</output>
