---
phase: 07-polish-fixes
plan: 04
type: execute
wave: 2
depends_on: ["07-03"]
files_modified:
  - src/app/transcripts/page.tsx
  - src/app/transcripts/loading.tsx
  - src/app/transcripts/[id]/loading.tsx
  - src/app/modules/page.tsx
  - src/app/modules/new/page.tsx
  - src/app/modules/[id]/edit/page.tsx
  - src/components/transcripts/TranscriptReader.tsx
  - src/components/transcripts/TranscriptHeader.tsx
  - src/components/transcripts/TranscriptListItem.tsx
  - src/components/transcripts/TranscriptFilters.tsx
  - src/components/transcripts/ParagraphView.tsx
  - src/components/transcripts/SearchSidebar.tsx
  - src/components/transcripts/ResumePrompt.tsx
  - src/components/modules/ModuleCard.tsx
  - src/components/modules/ModuleForm.tsx
  - src/components/modules/ModuleSelector.tsx
  - src/components/modules/DeleteModuleDialog.tsx
  - src/components/modules/InlineModuleCreator.tsx
  - src/components/annotations/AnnotationSidebar.tsx
  - src/components/annotations/SelectionToolbar.tsx
  - src/components/annotations/HighlightPopover.tsx
  - src/components/annotations/HighlightRenderer.tsx
  - src/components/analysis/TraceCard.tsx
  - src/components/analysis/TraceList.tsx
  - src/components/analysis/ModuleSwitcher.tsx
  - src/app/analysis/modules/[id]/page.tsx
  - src/components/export/BulkExportButton.tsx
  - src/components/export/ExportButtons.tsx
autonomous: false
requirements: []

must_haves:
  truths:
    - "All pages render correctly in dark mode with soft dark palette"
    - "Text is readable against dark backgrounds throughout the app"
    - "Annotation highlights adjust opacity for dark backgrounds (0.5 vs 0.35)"
    - "No hardcoded light-only colors remain visible in dark mode"
    - "Transitions between light and dark mode are smooth (200ms)"
    - "Modules page (already has dark: variants) still works correctly"
  artifacts:
    - path: "src/components/transcripts/TranscriptReader.tsx"
      provides: "Reader with dark mode support"
      contains: "dark:"
    - path: "src/components/annotations/HighlightRenderer.tsx"
      provides: "Highlight rendering with dark-adjusted opacity via CSS variable"
      contains: "highlight-opacity"
    - path: "src/components/annotations/AnnotationSidebar.tsx"
      provides: "Sidebar with dark mode support"
      contains: "dark:"
  key_links:
    - from: "src/components/annotations/HighlightRenderer.tsx"
      to: "src/app/globals.css"
      via: "--highlight-opacity CSS variable"
      pattern: "highlight-opacity"
---

<objective>
Add dark mode variants to all pages and components in the app. Updates ~25 files to replace hardcoded light-mode colors with dark: variants using the soft dark palette (#1a1a2e background, #e8e8f0 text, #2d2d4a borders, #16213e muted).

Purpose: Complete dark mode support across the entire app (user decision: applies to whole app, not just reader)
Output: All components updated with dark: Tailwind variants
</objective>

<execution_context>
@/Users/bharadwajkulkarni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bharadwajkulkarni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-fixes/07-RESEARCH.md
@.planning/phases/07-polish-fixes/07-03-SUMMARY.md
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dark mode to transcript pages and reader components</name>
  <files>
    src/app/transcripts/page.tsx
    src/app/transcripts/loading.tsx
    src/app/transcripts/[id]/loading.tsx
    src/components/transcripts/TranscriptReader.tsx
    src/components/transcripts/TranscriptHeader.tsx
    src/components/transcripts/TranscriptListItem.tsx
    src/components/transcripts/TranscriptFilters.tsx
    src/components/transcripts/ParagraphView.tsx
    src/components/transcripts/SearchSidebar.tsx
    src/components/transcripts/ResumePrompt.tsx
  </files>
  <action>
Add `dark:` variants to all hardcoded light-mode color classes in transcript-related components. Use the following mapping consistently throughout (matching the CSS variables in globals.css):

**Color mapping:**
- `bg-white` → `bg-white dark:bg-[#1a1a2e]`
- `bg-gray-50` → `bg-gray-50 dark:bg-[#16213e]`
- `text-gray-900` → `text-gray-900 dark:text-[#e8e8f0]`
- `text-gray-700` → `text-gray-700 dark:text-[#c0c0d0]`
- `text-gray-600` → `text-gray-600 dark:text-[#9090b0]`
- `text-gray-500` → `text-gray-500 dark:text-[#9090b0]`
- `text-gray-400` → `text-gray-400 dark:text-[#6a6a8a]`
- `border-gray-100` → `border-gray-100 dark:border-[#2d2d4a]`
- `border-gray-200` → `border-gray-200 dark:border-[#2d2d4a]`
- `border-gray-300` → `border-gray-300 dark:border-[#3d3d5a]`
- `bg-yellow-50` → `bg-yellow-50 dark:bg-yellow-900/30` (search current match)
- `bg-yellow-200` → `bg-yellow-200 dark:bg-yellow-700/50` (search highlight)
- `hover:bg-gray-50` → `hover:bg-gray-50 dark:hover:bg-[#16213e]`
- `hover:bg-gray-100` → `hover:bg-gray-100 dark:hover:bg-[#2d2d4a]`
- `ring-*` colors → add appropriate dark variants
- `placeholder-gray-*` → add dark variants

**Specific files and key changes:**

1. **TranscriptReader.tsx** (~6 occurrences): `bg-white`, `min-h-screen bg-white`, borders, scrollbar areas
2. **ParagraphView.tsx** (~1): `text-gray-900` on the `<p>` tag, `text-gray-400` on timestamp, `text-gray-700` on speaker label, `bg-yellow-50` on current match
3. **SearchSidebar.tsx** (~5): `bg-white`, `border-gray-200`, `text-gray-*` throughout
4. **TranscriptHeader.tsx** (~2): `text-gray-*` colors
5. **TranscriptListItem.tsx** (~2): `bg-white`, `text-gray-*`
6. **TranscriptFilters.tsx** (~1): `bg-white`, inputs
7. **ResumePrompt.tsx** (~2): `bg-white`, `text-gray-*`
8. **transcripts/page.tsx** (~2): page background, heading colors
9. **Loading pages** (~5 combined): skeleton/loading state colors

Do NOT modify existing `dark:` classes that already exist — add to elements that are missing them.
  </action>
  <verify>
    <automated>cd "/Users/bharadwajkulkarni/Documents /Bawa's Lab/mckenna-wiki" && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Run dev server, toggle dark mode, navigate to /transcripts and open a transcript — verify readability and no white/bright elements</manual>
  </verify>
  <done>All transcript pages and reader components have dark mode support with consistent palette</done>
</task>

<task type="auto">
  <name>Task 2: Add dark mode to modules, annotations, analysis, and export components</name>
  <files>
    src/app/modules/new/page.tsx
    src/app/modules/[id]/edit/page.tsx
    src/components/modules/ModuleCard.tsx
    src/components/modules/ModuleForm.tsx
    src/components/modules/ModuleSelector.tsx
    src/components/modules/DeleteModuleDialog.tsx
    src/components/modules/InlineModuleCreator.tsx
    src/components/annotations/AnnotationSidebar.tsx
    src/components/annotations/SelectionToolbar.tsx
    src/components/annotations/HighlightPopover.tsx
    src/components/annotations/HighlightRenderer.tsx
    src/components/analysis/TraceCard.tsx
    src/components/analysis/TraceList.tsx
    src/components/analysis/ModuleSwitcher.tsx
    src/app/analysis/modules/[id]/page.tsx
    src/components/export/BulkExportButton.tsx
    src/components/export/ExportButtons.tsx
  </files>
  <action>
Add `dark:` variants to remaining components using the same color mapping from Task 1.

**Specific focus areas:**

1. **AnnotationSidebar.tsx** (~8 occurrences): This has the most hardcoded colors. Update all `bg-white`, `border-gray-*`, `text-gray-*` classes. The sidebar toggle button (fixed right-4 top-24) needs dark variants too.

2. **HighlightRenderer.tsx**: Update `getHighlightStyle` to use CSS variable for opacity:
   - Change the tagged highlight return from:
     ```typescript
     return { backgroundColor: `rgba(${r}, ${g}, ${b}, 0.35)` }
     ```
     to:
     ```typescript
     return { backgroundColor: `rgba(${r}, ${g}, ${b}, var(--highlight-opacity, 0.35))` }
     ```
   - Change the untagged highlight from `{ backgroundColor: '#e5e7eb' }` to use a class-compatible approach. Since this is an inline style, use a lighter gray in dark mode. The simplest approach: keep `#e5e7eb` for light and detect dark mode is impractical in a pure function. Instead, keep `#e5e7eb` as-is — the `<mark>` element in `renderTextWithHighlights` can add a CSS class `dark:!bg-gray-700` alongside the inline style to override in dark mode.

   Wait — inline styles have higher specificity than Tailwind classes. Better approach: Use the CSS variable pattern for untagged too:
   ```css
   /* In globals.css (already done in Plan 03): */
   :root { --untagged-highlight: #e5e7eb; }
   .dark { --untagged-highlight: #4a4a6a; }
   ```
   Then in getHighlightStyle:
   ```typescript
   if (!color) {
     return { backgroundColor: 'var(--untagged-highlight, #e5e7eb)' }
   }
   ```
   **Note:** This requires adding `--untagged-highlight` to globals.css (minor addition to Plan 03's CSS variables). Add it here if not already present.

3. **HighlightPopover.tsx** (~1): `bg-white` background, border colors, text colors
4. **SelectionToolbar.tsx** (~1): button colors (already amber-themed, just needs dark border/shadow)
5. **ModuleCard.tsx** (~1): `bg-white` → add dark variant
6. **ModuleForm.tsx** (~2): input fields, labels
7. **ModuleSelector.tsx** (~1): dropdown background, borders
8. **DeleteModuleDialog.tsx** (~1): dialog background, text
9. **InlineModuleCreator.tsx** (~1): input, button colors
10. **Analysis components** (~4 combined): TraceCard, TraceList, ModuleSwitcher backgrounds/text
11. **Analysis page**: background, heading colors
12. **Export components**: button colors/borders (check if they need dark variants)

**Modules page (`src/app/modules/page.tsx`)** already has `dark:` variants with zinc palette — do NOT modify it. Other module components that appear within it should match the zinc palette where they're used on that page, but use the #1a1a2e palette when they appear in other contexts (like the ModuleSelector in the reader). For consistency, use the custom palette (#1a1a2e etc.) everywhere — the modules page's existing zinc variants will be close enough and won't conflict.
  </action>
  <verify>
    <automated>cd "/Users/bharadwajkulkarni/Documents /Bawa's Lab/mckenna-wiki" && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Toggle dark mode and visit: /modules, /modules/new, /transcripts (open one and test highlights, sidebar, popover), /analysis/modules/[id] — verify no bright/white elements leak through</manual>
  </verify>
  <done>All module, annotation, analysis, and export components have dark mode support</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify dark mode across all pages</name>
  <files>src/app/globals.css</files>
  <action>Human verification checkpoint — test dark mode across all app pages and verify visual consistency.</action>
  <verify>
    1. Visit http://localhost:3000 — toggle dark mode via sun/moon button in top-right
    2. Navigate to /transcripts — verify list items, filters, search all render in dark theme
    3. Open a transcript — verify reader background, text, timestamps, speaker labels, sidebar all dark
    4. If you have highlights: verify annotation colors are visible and readable against dark background
    5. Visit /modules — verify module cards, create/edit forms render in dark theme
    6. Visit /analysis/modules/[id] — verify trace cards render in dark theme
    7. Toggle back to light mode — verify everything returns to normal
    8. Refresh page — verify theme preference persists from localStorage
    9. Check system preference: change OS to dark mode (no localStorage set) — verify app follows
  </verify>
  <done>User confirms dark mode renders correctly across all pages with no bright/white leaks</done>
</task>

</tasks>

<verification>
- [ ] No hardcoded `bg-white` or `text-gray-900` without corresponding `dark:` variants in any component
- [ ] Highlight opacity uses CSS variable (0.35 light / 0.5 dark)
- [ ] Untagged highlight color adjusts for dark mode
- [ ] All pages tested: transcripts list, transcript reader, modules, module form, analysis trace
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
- Complete dark mode support across entire app
- All text readable, all backgrounds consistent with soft dark palette
- Annotation highlights visible and readable in both themes
- Human verification confirms acceptable dark mode appearance
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-fixes/07-04-SUMMARY.md`
</output>
