---
phase: 07-polish-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/globals.css
  - src/app/layout.tsx
  - src/components/DarkModeToggle.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "Dark mode activates when system preference is dark (and no localStorage override)"
    - "Dark mode can be toggled via sun/moon button"
    - "Theme preference persists in localStorage across sessions"
    - "CSS variables switch between light and dark palettes"
    - "Smooth ~200ms transition between themes"
    - "Highlight opacity adjusts automatically in dark mode via CSS variable"
  artifacts:
    - path: "src/app/globals.css"
      provides: "Dark mode CSS variables, @custom-variant, highlight opacity variable"
      contains: "@custom-variant dark"
    - path: "src/app/layout.tsx"
      provides: "Theme initialization script in head, DarkModeToggle in body"
      contains: "localStorage.getItem"
    - path: "src/components/DarkModeToggle.tsx"
      provides: "Client component with sun/moon toggle button"
      contains: "use client"
  key_links:
    - from: "src/app/layout.tsx"
      to: "document.documentElement"
      via: "Inline script adds .dark class before paint"
      pattern: "classList\\.add.*dark"
    - from: "src/components/DarkModeToggle.tsx"
      to: "document.documentElement.classList"
      via: "Toggle button adds/removes .dark class"
      pattern: "classList\\.toggle.*dark"
    - from: "src/app/globals.css"
      to: "all components using dark: prefix"
      via: "@custom-variant dark rule"
      pattern: "@custom-variant dark"
---

<objective>
Set up dark mode infrastructure: CSS variables with light/dark palettes, Tailwind v4 @custom-variant configuration, theme initialization script, and toggle component. This provides the foundation that Plan 04 uses to add dark: variants to all components.

Purpose: Dark mode infrastructure for the whole app (user decision: soft dark #1a1a2e palette, Linear/Notion style)
Output: globals.css with dark variables, layout.tsx with theme script, DarkModeToggle component
</objective>

<execution_context>
@/Users/bharadwajkulkarni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bharadwajkulkarni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-fixes/07-RESEARCH.md
@src/app/globals.css
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure dark mode CSS variables and Tailwind custom variant</name>
  <files>src/app/globals.css</files>
  <action>
Update `src/app/globals.css` to add dark mode support:

1. **Add `@custom-variant` after the import:**
   ```css
   @import "tailwindcss";

   @custom-variant dark (&:where(.dark, .dark *));
   ```

2. **Expand `:root` with full light palette variables:**
   ```css
   :root {
     --background: #ffffff;
     --foreground: #171717;
     --border: #e5e7eb;
     --muted: #f3f4f6;
     --muted-foreground: #6b7280;
     --card: #ffffff;
     --card-foreground: #171717;
     --highlight-opacity: 0.35;
     color-scheme: light;
   }
   ```

3. **Add `.dark` class with soft dark palette (Linear/Notion style per user decision):**
   ```css
   .dark {
     --background: #1a1a2e;
     --foreground: #e8e8f0;
     --border: #2d2d4a;
     --muted: #16213e;
     --muted-foreground: #9090b0;
     --card: #16213e;
     --card-foreground: #e8e8f0;
     --highlight-opacity: 0.5;
     color-scheme: dark;
   }
   ```

4. **Update the `@theme inline` block** to expose all variables:
   ```css
   @theme inline {
     --color-background: var(--background);
     --color-foreground: var(--foreground);
     --color-border: var(--border);
     --color-muted: var(--muted);
     --color-muted-foreground: var(--muted-foreground);
     --color-card: var(--card);
     --color-card-foreground: var(--card-foreground);
     --font-sans: var(--font-geist-sans);
     --font-mono: var(--font-geist-mono);
   }
   ```

5. **Add transition to body** for smooth 200ms theme switch:
   ```css
   body {
     background: var(--background);
     color: var(--foreground);
     transition: background-color 200ms ease, color 200ms ease;
     font-family: Arial, Helvetica, sans-serif;
   }
   ```

The `--highlight-opacity` CSS variable is used by HighlightRenderer to adjust annotation highlight opacity in dark mode (0.35 light, 0.5 dark) — this will be referenced in Plan 04 when updating highlight rendering.
  </action>
  <verify>
    <automated>cd "/Users/bharadwajkulkarni/Documents /Bawa's Lab/mckenna-wiki" && grep -c "@custom-variant dark" src/app/globals.css && grep -c "highlight-opacity" src/app/globals.css</automated>
    <manual>Verify CSS contains both :root and .dark variable blocks with the correct palette values</manual>
  </verify>
  <done>globals.css has @custom-variant dark, light/dark CSS variable palettes, and highlight-opacity variable</done>
</task>

<task type="auto">
  <name>Task 2: Add theme script and DarkModeToggle to layout</name>
  <files>src/app/layout.tsx, src/components/DarkModeToggle.tsx</files>
  <action>
**Create `src/components/DarkModeToggle.tsx`** — client component with sun/moon toggle:

```tsx
'use client'
import { useEffect, useState } from 'react'

export function DarkModeToggle() {
  const [isDark, setIsDark] = useState(false)

  useEffect(() => {
    // Sync with current state on mount
    setIsDark(document.documentElement.classList.contains('dark'))
  }, [])

  function toggle() {
    const next = !isDark
    setIsDark(next)
    document.documentElement.classList.toggle('dark', next)
    localStorage.setItem('theme', next ? 'dark' : 'light')
  }

  return (
    <button
      onClick={toggle}
      className="fixed top-4 right-4 z-50 rounded-lg p-2 text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800 transition-colors"
      aria-label="Toggle dark mode"
      title={isDark ? 'Switch to light mode' : 'Switch to dark mode'}
    >
      {isDark ? (
        {/* Sun icon */}
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
        </svg>
      ) : (
        {/* Moon icon */}
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
          <path strokeLinecap="round" strokeLinejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
        </svg>
      )}
    </button>
  )
}
```

**Update `src/app/layout.tsx`:**

1. Add inline theme initialization script in `<head>` to apply `.dark` class before paint:
   ```tsx
   <script dangerouslySetInnerHTML={{ __html: `
     (function() {
       var theme = localStorage.getItem('theme');
       if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
         document.documentElement.classList.add('dark');
       }
     })();
   `}} />
   ```

2. Import and render `DarkModeToggle` in the body (after `{children}`):
   ```tsx
   import { DarkModeToggle } from '@/components/DarkModeToggle'
   // ... in body:
   {children}
   <DarkModeToggle />
   ```

3. Update metadata title from "Create Next App" to "McKenna Wiki" and description to something appropriate.

The toggle uses `fixed top-4 right-4 z-50` positioning to float above all page content without conflicting with existing page layouts. The `z-50` ensures it appears above sidebars (which use z-10/z-20).

Initialize with `useState(false)` and sync in `useEffect` — standard Next.js pattern to avoid hydration mismatch. Brief wrong-icon flash is acceptable per user decision (FOUC not a concern).
  </action>
  <verify>
    <automated>cd "/Users/bharadwajkulkarni/Documents /Bawa's Lab/mckenna-wiki" && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Run `npm run dev`, toggle dark mode via button — background should change to #1a1a2e, text to light. Refresh page — preference should persist.</manual>
  </verify>
  <done>DarkModeToggle component created, layout.tsx has theme initialization script and renders toggle. Theme follows system preference with localStorage override.</done>
</task>

</tasks>

<verification>
- [ ] `@custom-variant dark` present in globals.css
- [ ] `:root` and `.dark` CSS variable blocks with correct palette values
- [ ] `--highlight-opacity` variable switches between 0.35 (light) and 0.5 (dark)
- [ ] Theme initialization script in layout.tsx `<head>`
- [ ] DarkModeToggle component renders sun/moon icon and toggles `.dark` class
- [ ] localStorage persistence for theme preference
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
- Dark mode infrastructure functional: toggle switches themes, system preference respected, localStorage persists choice
- CSS variables ready for Plan 04 to add dark: variants throughout components
- Highlight opacity variable ready for HighlightRenderer dark mode adjustment
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-fixes/07-03-SUMMARY.md`
</output>
