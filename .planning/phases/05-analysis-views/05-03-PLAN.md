---
phase: 05-analysis-views
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/components/analysis/ModuleSwitcher.tsx
  - src/components/modules/ModuleCard.tsx
  - src/app/analysis/modules/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can switch between modules within trace view using dropdown"
    - "Modules page shows 'View traces' action on each module card"
    - "Module cards display passage count"
  artifacts:
    - path: "src/components/analysis/ModuleSwitcher.tsx"
      provides: "Dropdown to switch modules in trace view"
      min_lines: 30
    - path: "src/components/modules/ModuleCard.tsx"
      provides: "Updated card with trace link and passage count"
      contains: "View traces"
  key_links:
    - from: "src/components/modules/ModuleCard.tsx"
      to: "/analysis/modules/[id]"
      via: "Link component"
      pattern: "/analysis/modules/"
    - from: "src/components/analysis/ModuleSwitcher.tsx"
      to: "/analysis/modules/[id]"
      via: "router.push"
      pattern: "router\\.push"
---

<objective>
Add navigation entry points to the module tracing feature.

Purpose: Users need multiple ways to access trace views - from the modules page (seeing which modules have passages) and from within a trace view (switching to compare different modules). This completes the navigation story.

Output: Module cards show passage counts with "View traces" links, and trace view has module switcher dropdown.
</objective>

<execution_context>
@/Users/bharadwajkulkarni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bharadwajkulkarni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-analysis-views/05-CONTEXT.md

# Plan 02 outputs
@src/app/analysis/modules/[id]/page.tsx
@src/components/analysis/TraceList.tsx

# Existing components to update
@src/components/modules/ModuleCard.tsx
@src/app/modules/page.tsx
@src/lib/types/module.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ModuleSwitcher dropdown</name>
  <files>src/components/analysis/ModuleSwitcher.tsx</files>
  <action>
Create client component for switching modules within trace view:

```typescript
'use client'

import { useRouter } from 'next/navigation'
import { useState } from 'react'
import type { Module } from '@/lib/types/module'

interface ModuleSwitcherProps {
  currentModuleId: string
  modules: Pick<Module, 'id' | 'name' | 'color'>[]
}

export function ModuleSwitcher({ currentModuleId, modules }: ModuleSwitcherProps) {
  const router = useRouter()
  const [isOpen, setIsOpen] = useState(false)

  const currentModule = modules.find(m => m.id === currentModuleId)

  function handleSelect(moduleId: string) {
    setIsOpen(false)
    if (moduleId !== currentModuleId) {
      router.push(`/analysis/modules/${moduleId}`)
    }
  }

  return (
    <div className="relative">
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 hover:bg-zinc-50 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-100 dark:hover:bg-zinc-700"
      >
        {currentModule && (
          <span
            className="h-3 w-3 rounded-full"
            style={{ backgroundColor: currentModule.color }}
          />
        )}
        <span>Switch module</span>
        <svg
          className={`h-4 w-4 transition-transform ${isOpen ? 'rotate-180' : ''}`}
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {isOpen && (
        <>
          {/* Backdrop */}
          <div
            className="fixed inset-0 z-10"
            onClick={() => setIsOpen(false)}
          />

          {/* Dropdown menu */}
          <div className="absolute right-0 top-full z-20 mt-1 max-h-64 w-56 overflow-y-auto rounded-lg border border-zinc-200 bg-white shadow-lg dark:border-zinc-700 dark:bg-zinc-800">
            {modules.map(module => (
              <button
                key={module.id}
                onClick={() => handleSelect(module.id)}
                className={`flex w-full items-center gap-2 px-3 py-2 text-left text-sm hover:bg-zinc-100 dark:hover:bg-zinc-700 ${
                  module.id === currentModuleId
                    ? 'bg-zinc-100 dark:bg-zinc-700'
                    : ''
                }`}
              >
                <span
                  className="h-3 w-3 flex-shrink-0 rounded-full"
                  style={{ backgroundColor: module.color }}
                />
                <span className="truncate text-zinc-900 dark:text-zinc-100">
                  {module.name}
                </span>
              </button>
            ))}
          </div>
        </>
      )}
    </div>
  )
}
```

Features:
- Simple dropdown (no Floating UI needed for this case)
- Shows current module color indicator
- Navigates on selection via router.push
- Backdrop click closes dropdown
- Scrollable for many modules
  </action>
  <verify>
In trace view, click "Switch module" - dropdown appears with all modules. Selecting a different module navigates to its trace page.
  </verify>
  <done>ModuleSwitcher allows switching between module traces via dropdown</done>
</task>

<task type="auto">
  <name>Task 2: Update trace page to include ModuleSwitcher</name>
  <files>src/app/analysis/modules/[id]/page.tsx</files>
  <action>
Update page to fetch all modules and include ModuleSwitcher:

1. Add import: `import { ModuleSwitcher } from '@/components/analysis/ModuleSwitcher'`

2. Add modules query to parallel fetch:
```typescript
const [moduleWithCount, traces, allModulesResult] = await Promise.all([
  getModuleWithCount(id),
  getModuleTraces(id),
  supabase.from('modules').select('id, name, color').order('name')
])

const allModules = allModulesResult.data || []
```

3. Add ModuleSwitcher in header (after h1):
```typescript
<div className="mb-8">
  <div className="flex items-start justify-between">
    <div>
      <Link href="/modules" className="...">← Back to modules</Link>
      <h1 className="...">...</h1>
    </div>
    <ModuleSwitcher
      currentModuleId={id}
      modules={allModules}
    />
  </div>
  {moduleWithCount.notes && ...}
</div>
```

Import createClient at top of file.
  </action>
  <verify>
Trace page shows "Switch module" dropdown in header. Dropdown lists all modules. Navigation works.
  </verify>
  <done>Trace page includes working module switcher in header</done>
</task>

<task type="auto">
  <name>Task 3: Update ModuleCard with passage count and trace link</name>
  <files>
    src/components/modules/ModuleCard.tsx
    src/app/modules/page.tsx
  </files>
  <action>
**src/components/modules/ModuleCard.tsx:**
Update to show passage count and "View traces" link:

```typescript
import Link from 'next/link'
import type { Module } from '@/lib/types/module'

interface ModuleCardProps {
  module: Module
  passageCount?: number  // Optional for backward compatibility
}

export function ModuleCard({ module, passageCount }: ModuleCardProps) {
  return (
    <div className="group rounded-lg border border-zinc-200 bg-white p-4 dark:border-zinc-800 dark:bg-zinc-950">
      <div className="flex items-start gap-3">
        <div
          className="mt-1 h-4 w-4 rounded-full flex-shrink-0"
          style={{ backgroundColor: module.color }}
        />
        <div className="flex-1 min-w-0">
          <h3 className="font-medium text-zinc-900 dark:text-zinc-100 truncate">
            {module.name}
          </h3>
          {module.notes && (
            <p className="mt-1 text-sm text-zinc-600 dark:text-zinc-400 line-clamp-2">
              {module.notes}
            </p>
          )}

          {/* Actions row */}
          <div className="mt-3 flex items-center gap-4 text-sm">
            <Link
              href={`/modules/${module.id}/edit`}
              className="text-zinc-600 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-zinc-100"
            >
              Edit
            </Link>
            <Link
              href={`/analysis/modules/${module.id}`}
              className="text-zinc-600 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-zinc-100"
            >
              View traces
              {passageCount !== undefined && passageCount > 0 && (
                <span className="ml-1 text-zinc-400">({passageCount})</span>
              )}
            </Link>
          </div>
        </div>
      </div>
    </div>
  )
}
```

**src/app/modules/page.tsx:**
Update to fetch passage counts:

```typescript
import { createClient } from '@/lib/supabase/server'
import { ModuleCard } from '@/components/modules/ModuleCard'
import Link from 'next/link'
import type { Module } from '@/lib/types/module'

export default async function ModulesPage() {
  const supabase = await createClient()

  // Fetch modules and annotation counts
  const [modulesResult, countsResult] = await Promise.all([
    supabase.from('modules').select('*').order('created_at', { ascending: false }),
    supabase.from('annotations').select('module_id').not('module_id', 'is', null)
  ])

  const modules = modulesResult.data || []

  // Count passages per module
  const passageCounts: Record<string, number> = {}
  for (const ann of countsResult.data || []) {
    if (ann.module_id) {
      passageCounts[ann.module_id] = (passageCounts[ann.module_id] || 0) + 1
    }
  }

  return (
    // ... existing structure
    {modules.map((module: Module) => (
      <ModuleCard
        key={module.id}
        module={module}
        passageCount={passageCounts[module.id] || 0}
      />
    ))}
    // ...
  )
}
```

Keep rest of page structure the same. This approach fetches counts efficiently in a single query.
  </action>
  <verify>
Modules page shows "Edit" and "View traces (N)" links on each card. Clicking "View traces" navigates to /analysis/modules/[id].
  </verify>
  <done>Module cards display passage counts and link to trace view</done>
</task>

</tasks>

<verification>
1. Modules page shows "Edit" and "View traces (N)" on each card
2. "View traces" navigates to /analysis/modules/[id]
3. Trace page shows "Switch module" dropdown
4. Switching modules navigates to new trace page
5. Passage counts accurate on module cards
</verification>

<success_criteria>
- ModuleCard shows passage count and "View traces" link
- Trace page has working ModuleSwitcher dropdown
- Navigation flows work: Modules → Trace → Different Trace
- All navigation links work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/05-analysis-views/05-03-SUMMARY.md`
</output>
