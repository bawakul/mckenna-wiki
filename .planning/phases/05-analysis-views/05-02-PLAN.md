---
phase: 05-analysis-views
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/analysis/modules/[id]/page.tsx
  - src/app/analysis/modules/[id]/loading.tsx
  - src/components/analysis/TraceList.tsx
  - src/components/analysis/TraceCard.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /analysis/modules/[id] and see passages for that module"
    - "Passages display with highlighted text and lecture title + date"
    - "Text search filters passages without blocking input (useTransition)"
    - "Empty state shown when no passages exist for module"
  artifacts:
    - path: "src/app/analysis/modules/[id]/page.tsx"
      provides: "Module trace page with SSR data fetch"
      min_lines: 40
    - path: "src/components/analysis/TraceList.tsx"
      provides: "Client component with useTransition filtering"
      contains: "useTransition"
    - path: "src/components/analysis/TraceCard.tsx"
      provides: "Individual passage card with expandable context"
      min_lines: 30
  key_links:
    - from: "src/app/analysis/modules/[id]/page.tsx"
      to: "src/lib/queries/module-traces.ts"
      via: "import getModuleTraces"
      pattern: "getModuleTraces"
    - from: "src/components/analysis/TraceList.tsx"
      to: "TraceCard"
      via: "maps traces to TraceCard components"
      pattern: "TraceCard"
---

<objective>
Build the module trace page with card stack display and text filtering.

Purpose: This is the core analysis feature - seeing all passages tagged with a module across the entire corpus, sorted chronologically. Users can scan how McKenna discussed a concept over time.

Output: Working trace page at /analysis/modules/[id] with searchable card list showing passages in chronological order.
</objective>

<execution_context>
@/Users/bharadwajkulkarni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bharadwajkulkarni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-analysis-views/05-CONTEXT.md
@.planning/phases/05-analysis-views/05-RESEARCH.md

# Plan 01 outputs
@src/lib/types/trace.ts
@src/lib/queries/module-traces.ts

# Existing patterns to follow
@src/app/modules/page.tsx
@src/app/transcripts/[id]/page.tsx
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trace page with Server Component data fetch</name>
  <files>
    src/app/analysis/modules/[id]/page.tsx
    src/app/analysis/modules/[id]/loading.tsx
  </files>
  <action>
**src/app/analysis/modules/[id]/page.tsx:**
Server Component that fetches module and traces in parallel:

```typescript
import { createClient } from '@/lib/supabase/server'
import { getModuleTraces, getModuleWithCount } from '@/lib/queries/module-traces'
import { TraceList } from '@/components/analysis/TraceList'
import { notFound } from 'next/navigation'
import Link from 'next/link'

interface PageProps {
  params: Promise<{ id: string }>
}

export default async function ModuleTracePage({ params }: PageProps) {
  const { id } = await params

  // Parallel fetch (no waterfall)
  const [moduleWithCount, traces] = await Promise.all([
    getModuleWithCount(id),
    getModuleTraces(id)
  ])

  if (!moduleWithCount) {
    notFound()
  }

  return (
    <div className="min-h-screen bg-zinc-50 dark:bg-zinc-900">
      <div className="mx-auto max-w-4xl px-4 py-12">
        {/* Header with back link */}
        <div className="mb-8">
          <Link
            href="/modules"
            className="text-sm text-zinc-500 hover:text-zinc-700 dark:text-zinc-400"
          >
            ← Back to modules
          </Link>
          <h1 className="mt-4 text-3xl font-bold text-zinc-900 dark:text-zinc-50">
            {moduleWithCount.name}
            <span className="ml-3 text-zinc-500 text-lg font-normal">
              ({traces.length} {traces.length === 1 ? 'passage' : 'passages'})
            </span>
          </h1>
          {moduleWithCount.notes && (
            <p className="mt-2 text-zinc-600 dark:text-zinc-400">
              {moduleWithCount.notes}
            </p>
          )}
        </div>

        {traces.length === 0 ? (
          <div className="rounded-lg border border-dashed border-zinc-300 p-12 text-center dark:border-zinc-700">
            <p className="text-zinc-600 dark:text-zinc-400">
              No passages tagged with this module yet.
            </p>
            <Link
              href="/transcripts"
              className="mt-4 inline-block text-sm font-medium text-zinc-900 underline dark:text-zinc-100"
            >
              Browse transcripts to start tagging
            </Link>
          </div>
        ) : (
          <TraceList traces={traces} moduleColor={moduleWithCount.color} />
        )}
      </div>
    </div>
  )
}
```

**src/app/analysis/modules/[id]/loading.tsx:**
Simple loading skeleton:

```typescript
export default function Loading() {
  return (
    <div className="min-h-screen bg-zinc-50 dark:bg-zinc-900">
      <div className="mx-auto max-w-4xl px-4 py-12">
        <div className="mb-8">
          <div className="h-4 w-24 bg-zinc-200 rounded animate-pulse" />
          <div className="mt-4 h-8 w-64 bg-zinc-200 rounded animate-pulse" />
        </div>
        <div className="space-y-4">
          {[1, 2, 3].map((i) => (
            <div key={i} className="h-32 bg-zinc-200 rounded-lg animate-pulse" />
          ))}
        </div>
      </div>
    </div>
  )
}
```

Follow existing page patterns from transcripts/[id]/page.tsx and modules/page.tsx.
Dark mode support with dark: variants.
  </action>
  <verify>
Navigate to `/analysis/modules/[id]` with a valid module ID. Page should render without errors. Check browser console for any hydration errors.
  </verify>
  <done>Trace page renders module name, passage count, and either empty state or TraceList component</done>
</task>

<task type="auto">
  <name>Task 2: Build TraceList with useTransition filtering</name>
  <files>src/components/analysis/TraceList.tsx</files>
  <action>
Create client component with responsive text search:

```typescript
'use client'

import { useState, useTransition } from 'react'
import { TraceCard } from './TraceCard'
import type { ModuleTrace } from '@/lib/types/trace'

interface TraceListProps {
  traces: ModuleTrace[]
  moduleColor: string
}

export function TraceList({ traces, moduleColor }: TraceListProps) {
  const [searchQuery, setSearchQuery] = useState('')
  const [filteredTraces, setFilteredTraces] = useState(traces)
  const [isPending, startTransition] = useTransition()

  function handleSearch(query: string) {
    // Update input immediately (high priority)
    setSearchQuery(query)

    // Defer filtering (low priority, non-blocking)
    startTransition(() => {
      if (!query.trim()) {
        setFilteredTraces(traces)
        return
      }

      const lowercaseQuery = query.toLowerCase()
      const filtered = traces.filter(trace =>
        trace.highlighted_text.toLowerCase().includes(lowercaseQuery) ||
        trace.transcript_title.toLowerCase().includes(lowercaseQuery)
      )
      setFilteredTraces(filtered)
    })
  }

  return (
    <div>
      {/* Search input */}
      <div className="mb-6">
        <input
          type="text"
          value={searchQuery}
          onChange={(e) => handleSearch(e.target.value)}
          placeholder="Search passages..."
          className="w-full rounded-lg border border-zinc-300 bg-white px-4 py-2 text-zinc-900 placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-zinc-900 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-100 dark:placeholder-zinc-400 dark:focus:ring-zinc-100"
        />
        {isPending && (
          <p className="mt-2 text-sm text-zinc-500 dark:text-zinc-400">Filtering...</p>
        )}
      </div>

      {/* Results */}
      <div className="space-y-4">
        {filteredTraces.length === 0 && searchQuery ? (
          <p className="text-zinc-500 text-center py-12 dark:text-zinc-400">
            No passages match "{searchQuery}"
          </p>
        ) : (
          filteredTraces.map(trace => (
            <TraceCard
              key={trace.id}
              trace={trace}
              moduleColor={moduleColor}
            />
          ))
        )}
      </div>
    </div>
  )
}
```

Key points from RESEARCH.md:
- useTransition keeps input responsive during filter
- Search both highlighted_text and transcript_title
- isPending shows subtle feedback during filter
- No debouncing needed (useTransition handles it better)
  </action>
  <verify>
Type in search box - input should remain responsive even with many passages. Filtering feedback appears during search.
  </verify>
  <done>TraceList filters passages without blocking input, shows appropriate feedback</done>
</task>

<task type="auto">
  <name>Task 3: Build TraceCard with expandable context</name>
  <files>src/components/analysis/TraceCard.tsx</files>
  <action>
Create passage card with expand/collapse for context:

```typescript
'use client'

import { useState } from 'react'
import Link from 'next/link'
import type { ModuleTrace } from '@/lib/types/trace'

interface TraceCardProps {
  trace: ModuleTrace
  moduleColor: string
}

export function TraceCard({ trace, moduleColor }: TraceCardProps) {
  const [isExpanded, setIsExpanded] = useState(false)

  // Format date for display (handle various formats: "March 25, 1994", "June 1989", null)
  const displayDate = trace.transcript_date || 'Date unknown'

  return (
    <div className="rounded-lg border border-zinc-200 bg-white p-4 dark:border-zinc-800 dark:bg-zinc-950">
      {/* Card header: lecture title + date */}
      <div className="flex items-start justify-between gap-4 mb-3">
        <div className="min-w-0">
          <h3 className="font-medium text-zinc-900 dark:text-zinc-100 truncate">
            {trace.transcript_title}
          </h3>
          <p className="text-sm text-zinc-500 dark:text-zinc-400">
            {displayDate}
          </p>
        </div>
        <Link
          href={`/transcripts/${trace.transcript_id}`}
          className="flex-shrink-0 text-sm text-zinc-600 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-zinc-100"
        >
          View in lecture →
        </Link>
      </div>

      {/* Highlighted passage */}
      <div className="prose prose-zinc dark:prose-invert max-w-none">
        <p
          className="rounded-sm px-1 py-0.5"
          style={{ backgroundColor: `${moduleColor}59` }}  // 35% opacity
        >
          {trace.highlighted_text}
        </p>
      </div>

      {/* Expand/collapse button (for future context expansion) */}
      {/* Note: Full context expansion would require fetching surrounding paragraphs.
          For v1, just show the highlighted text. Can add expand later if needed. */}
    </div>
  )
}
```

Key decisions from CONTEXT.md:
- Minimal metadata (title + date only)
- Module color as background on highlighted text (35% opacity for readability)
- "View in lecture" link to transcript reader
- Card layout with clear separation

Note: Full expandable context (showing before/after paragraphs) deferred as it requires additional paragraph fetching. The highlighted_text alone provides sufficient value for v1. Can enhance later.
  </action>
  <verify>
Cards render with title, date, highlighted text with module color background, and working "View in lecture" link.
  </verify>
  <done>TraceCard displays passage with metadata and navigation link, module color applied to highlight</done>
</task>

</tasks>

<verification>
1. Navigate to `/analysis/modules/[valid-id]` - page renders
2. Search box filters passages without lag
3. Cards show title, date, highlighted text with color
4. "View in lecture" navigates to transcript reader
5. Empty state shows when module has no passages
6. Dark mode works throughout
</verification>

<success_criteria>
- Trace page accessible at /analysis/modules/[id]
- Passages sorted chronologically (oldest first)
- Text search filters passages responsively (no input lag)
- Cards display highlighted text with module color background
- Navigation to transcript reader works
- Empty state and loading states present
</success_criteria>

<output>
After completion, create `.planning/phases/05-analysis-views/05-02-SUMMARY.md`
</output>
