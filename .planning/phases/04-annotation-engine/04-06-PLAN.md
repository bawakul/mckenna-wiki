---
phase: 04-annotation-engine
plan: 06
type: execute
wave: 5
depends_on: ["04-03", "04-04", "04-05"]
files_modified:
  - src/components/transcripts/VirtualizedReader.tsx
  - src/components/transcripts/TranscriptReader.tsx
  - src/app/transcripts/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Selection toolbar appears when selecting text in transcript"
    - "Clicking Highlight creates annotation and shows it immediately"
    - "Existing annotations display in paragraph text"
    - "Clicking annotation shows popover with edit/delete options"
    - "Sidebar shows all annotations and enables navigation"
  artifacts:
    - path: "src/components/transcripts/VirtualizedReader.tsx"
      provides: "Reader with annotation support"
      contains: "SelectionToolbar"
    - path: "src/components/transcripts/TranscriptReader.tsx"
      provides: "Reader wrapper with sidebar"
      contains: "AnnotationSidebar"
    - path: "src/app/transcripts/[id]/page.tsx"
      provides: "Page with annotation data fetching"
      contains: "getAnnotationsForTranscript"
  key_links:
    - from: "TranscriptReader.tsx"
      to: "annotations/actions.ts"
      via: "data fetching"
      pattern: "getAnnotationsForTranscript"
    - from: "VirtualizedReader.tsx"
      to: "annotation components"
      via: "component composition"
      pattern: "SelectionToolbar|HighlightPopover"
---

<objective>
Integrate all annotation components into the transcript reading experience.

Purpose: Wire together the selection, highlighting, popover, and sidebar into a cohesive annotation workflow within the existing virtualized transcript reader.

Output: Complete annotation functionality working in the transcript view.
</objective>

<execution_context>
@/Users/bharadwajkulkarni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bharadwajkulkarni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-annotation-engine/04-CONTEXT.md
@.planning/phases/04-annotation-engine/04-03-PLAN.md
@.planning/phases/04-annotation-engine/04-04-PLAN.md
@.planning/phases/04-annotation-engine/04-05-PLAN.md
@src/components/transcripts/VirtualizedReader.tsx
@src/components/transcripts/TranscriptReader.tsx
@src/app/transcripts/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update VirtualizedReader with selection and highlights</name>
  <files>src/components/transcripts/VirtualizedReader.tsx</files>
  <action>
Add annotation support to VirtualizedReader:

1. Add new props for annotation handling:
```typescript
interface VirtualizedReaderProps {
  paragraphs: TranscriptParagraph[]
  transcriptId: string  // NEW - needed for annotation creation
  searchQuery?: string
  currentSearchParagraphIndex?: number
  hasTimestamps?: boolean
  onVisibleRangeChange?: (startIndex: number, endIndex: number) => void
  onScrollToIndexReady?: (fn: (index: number) => void) => void
  // Annotation props
  annotations?: AnnotationWithModule[]  // NEW
  onAnnotationCreated?: () => void      // NEW - callback to refresh
  onHighlightClick?: (annotationId: string, element: HTMLElement) => void  // NEW
}
```

2. Add imports:
```typescript
import { useRef, useMemo, useEffect, useCallback } from 'react'
import { useTextSelection } from '@/components/annotations/useTextSelection'
import { SelectionToolbar } from '@/components/annotations/SelectionToolbar'
import { createSelectorFromRange } from '@/lib/annotations/selectors'
import { createAnnotation } from '@/app/annotations/actions'
import { getHighlightsForParagraph } from '@/components/annotations/HighlightRenderer'
import type { AnnotationWithModule, ParagraphHighlight } from '@/lib/types/annotation'
```

3. Add selection handling inside component:
```typescript
// Container ref for selection detection
const containerRef = useRef<HTMLDivElement>(null)

const { selection, hasSelection, clearSelection } = useTextSelection({
  containerRef,
})

// Memoize highlights per paragraph
const highlightsByParagraph = useMemo(() => {
  const map = new Map<number, ParagraphHighlight[]>()
  if (!annotations) return map

  for (const para of paragraphs) {
    const highlights = getHighlightsForParagraph(
      para.id,
      para.text,
      annotations
    )
    if (highlights.length > 0) {
      map.set(para.id, highlights)
    }
  }
  return map
}, [paragraphs, annotations])

// Handle highlight creation
const handleCreateHighlight = useCallback(async () => {
  if (!selection.range) return

  const container = containerRef.current
  if (!container) return

  const { selector, startParagraphId, endParagraphId } = createSelectorFromRange(
    selection.range,
    container
  )

  const result = await createAnnotation({
    transcript_id: transcriptId,
    selector,
    highlighted_text: selection.text,
    start_paragraph_id: startParagraphId,
    end_paragraph_id: endParagraphId,
  })

  if (result.success) {
    clearSelection()
    window.getSelection()?.removeAllRanges()
    onAnnotationCreated?.()
  }
}, [selection, transcriptId, clearSelection, onAnnotationCreated])

// Handle clicking on a highlight
const handleHighlightClick = useCallback((annotationId: string) => {
  const element = document.querySelector(`mark[data-annotation-id="${annotationId}"]`) as HTMLElement
  if (element && onHighlightClick) {
    onHighlightClick(annotationId, element)
  }
}, [onHighlightClick])
```

4. Update container and pass highlights to ParagraphView:
```typescript
return (
  <div
    ref={(el) => {
      parentRef.current = el
      // Also set container ref for selection
      if (el) containerRef.current = el
    }}
    data-virtualized-container
    className="h-full overflow-auto px-8 py-8"
    style={{ contain: 'strict' }}
  >
    {/* Selection toolbar */}
    <SelectionToolbar
      selectionRect={selection.rect}
      onHighlight={handleCreateHighlight}
      isVisible={hasSelection}
    />

    <div className="max-w-2xl mx-auto" style={{ /* existing styles */ }}>
      {virtualItems.map((virtualItem) => {
        const paragraph = paragraphs[virtualItem.index]
        const highlights = highlightsByParagraph.get(paragraph.id)

        return (
          <div key={virtualItem.key} /* existing props */ >
            <ParagraphView
              paragraph={paragraph}
              showSpeaker={speakerVisibility[virtualItem.index]}
              searchQuery={searchQuery}
              isCurrentMatch={currentSearchParagraphIndex === virtualItem.index}
              hasTimestamps={hasTimestamps}
              highlights={highlights}  // NEW
              onHighlightClick={handleHighlightClick}  // NEW
            />
          </div>
        )
      })}
    </div>
  </div>
)
```

Note: The ref assignment needs to share between parentRef (for virtualizer) and containerRef (for selection). Use a callback ref that assigns both.
  </action>
  <verify>`npm run build` passes. Selection toolbar appears on text selection in virtualized reader.</verify>
  <done>VirtualizedReader supports text selection, highlight creation, and displays existing annotations.</done>
</task>

<task type="auto">
  <name>Task 2: Update TranscriptReader with sidebar and popover</name>
  <files>src/components/transcripts/TranscriptReader.tsx</files>
  <action>
Add sidebar and popover to TranscriptReader:

1. Add imports:
```typescript
import { useState, useCallback, useEffect } from 'react'
import { AnnotationSidebar, scrollToAnnotation } from '@/components/annotations/AnnotationSidebar'
import { HighlightPopover } from '@/components/annotations/HighlightPopover'
import { getAnnotationsForTranscript } from '@/app/annotations/actions'
import type { AnnotationWithModule } from '@/lib/types/annotation'
```

2. Add new props:
```typescript
interface TranscriptReaderProps {
  transcript: TranscriptWithParagraphs
  initialAnnotations?: AnnotationWithModule[]  // NEW - server-side loaded
}
```

3. Add state for annotations, sidebar, and popover:
```typescript
// Annotations state (can be refreshed after mutations)
const [annotations, setAnnotations] = useState<AnnotationWithModule[]>(
  initialAnnotations || []
)

// Sidebar state
const [isSidebarOpen, setIsSidebarOpen] = useState(false)

// Popover state
const [selectedAnnotation, setSelectedAnnotation] = useState<{
  annotation: AnnotationWithModule
  anchorElement: HTMLElement
} | null>(null)

// Refresh annotations after create/update/delete
const refreshAnnotations = useCallback(async () => {
  const result = await getAnnotationsForTranscript(transcript.id)
  if (result.success) {
    setAnnotations(result.data)
  }
}, [transcript.id])

// Handle highlight click (show popover)
const handleHighlightClick = useCallback((annotationId: string, element: HTMLElement) => {
  const annotation = annotations.find((a) => a.id === annotationId)
  if (annotation) {
    setSelectedAnnotation({ annotation, anchorElement: element })
  }
}, [annotations])

// Handle sidebar annotation click (scroll to it)
const handleSidebarAnnotationClick = useCallback((annotationId: string) => {
  scrollToAnnotation(annotationId)
}, [])
```

4. Update render:
```typescript
return (
  <div className="flex h-full">
    {/* Main reading area */}
    <div className={`flex-1 flex flex-col ${isSidebarOpen ? 'mr-80' : ''}`}>
      {/* Existing header, search, etc. */}

      {/* VirtualizedReader with annotation props */}
      <VirtualizedReader
        paragraphs={transcript.transcript_paragraphs}
        transcriptId={transcript.id}
        annotations={annotations}
        onAnnotationCreated={refreshAnnotations}
        onHighlightClick={handleHighlightClick}
        // ... existing props
      />
    </div>

    {/* Annotation sidebar */}
    <AnnotationSidebar
      annotations={annotations}
      isOpen={isSidebarOpen}
      onToggle={() => setIsSidebarOpen(!isSidebarOpen)}
      onAnnotationClick={handleSidebarAnnotationClick}
    />

    {/* Highlight popover */}
    {selectedAnnotation && (
      <HighlightPopover
        annotation={selectedAnnotation.annotation}
        anchorElement={selectedAnnotation.anchorElement}
        isOpen={true}
        onClose={() => setSelectedAnnotation(null)}
        onUpdated={refreshAnnotations}
      />
    )}
  </div>
)
```

Adjust main container layout to accommodate sidebar width.
  </action>
  <verify>`npm run build` passes. Sidebar toggles and popover appears on highlight click.</verify>
  <done>TranscriptReader includes sidebar, popover, and manages annotation state.</done>
</task>

<task type="auto">
  <name>Task 3: Update transcript page to fetch annotations</name>
  <files>src/app/transcripts/[id]/page.tsx</files>
  <action>
Add server-side annotation fetching to the transcript page:

1. Import the action:
```typescript
import { getAnnotationsForTranscript } from '@/app/annotations/actions'
```

2. Fetch annotations alongside transcript:
```typescript
export default async function TranscriptPage({ params }: { params: { id: string } }) {
  const { id } = params

  // Existing transcript fetch
  const supabase = await createClient()
  const { data: transcript, error } = await supabase
    .from('transcripts')
    .select('*, transcript_paragraphs(*)')
    .eq('id', id)
    .single()

  if (error || !transcript) {
    notFound()
  }

  // Fetch annotations
  const annotationsResult = await getAnnotationsForTranscript(id)
  const annotations = annotationsResult.success ? annotationsResult.data : []

  return (
    <TranscriptReader
      transcript={transcript}
      initialAnnotations={annotations}
    />
  )
}
```

This enables server-side rendering of annotations on initial page load.
  </action>
  <verify>Page loads with annotations visible (if any exist). No client-side flash of empty state.</verify>
  <done>Transcript page fetches annotations server-side and passes to reader component.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Text selection works in virtualized reader
3. Highlight button appears and creates annotation
4. Annotations display in paragraph text
5. Clicking annotation shows popover
6. Sidebar shows all annotations
7. Clicking sidebar entry scrolls to annotation
8. Module tagging works from popover
9. Delete works from popover
</verification>

<success_criteria>
- [ ] VirtualizedReader handles selection and displays highlights
- [ ] TranscriptReader integrates sidebar and popover
- [ ] Transcript page fetches annotations server-side
- [ ] Full annotation workflow functional
- [ ] `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-annotation-engine/04-06-SUMMARY.md`
</output>
